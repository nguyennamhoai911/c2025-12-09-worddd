Directory structure:
‚îî‚îÄ‚îÄ c2025-12-09-full-app-english/
    ‚îú‚îÄ‚îÄ AI_CONTEXT.md
    ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îî‚îÄ‚îÄ apps/
        ‚îú‚îÄ‚îÄ extension.crx
        ‚îú‚îÄ‚îÄ extension.pem
        ‚îú‚îÄ‚îÄ tree.txt
        ‚îú‚îÄ‚îÄ backend/
        ‚îÇ   ‚îú‚îÄ‚îÄ README.md
        ‚îÇ   ‚îú‚îÄ‚îÄ eslint.config.mjs
        ‚îÇ   ‚îú‚îÄ‚îÄ nest-cli.json
        ‚îÇ   ‚îú‚îÄ‚îÄ package.json
        ‚îÇ   ‚îú‚îÄ‚îÄ tree.txt
        ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.build.json
        ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
        ‚îÇ   ‚îú‚îÄ‚îÄ .prettierrc
        ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
        ‚îÇ   ‚îú‚îÄ‚îÄ src/
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.controller.spec.ts
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.controller.ts
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.service.ts
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.ts
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.module.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-auth.dto.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update-auth.dto.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.entity.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ google-auth.guard.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt-auth.guard.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ local-auth.guard.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ strategies/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ google.strategy.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ jwt.strategy.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ local.strategy.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.controller.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.module.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.service.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-user.dto.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ update-user.dto.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entities/
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ user.entity.ts
        ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vocabulary/
        ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ vocabulary.controller.ts
        ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ vocabulary.module.ts
        ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ vocabulary.service.ts
        ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dto/
        ‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ create-vocabulary.dto.ts
        ‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ update-vocabulary.dto.ts
        ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ entities/
        ‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ vocabulary.entity.ts
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prisma/
        ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ prisma.module.ts
        ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ prisma.service.ts
        ‚îÇ   ‚îî‚îÄ‚îÄ test/
        ‚îÇ       ‚îú‚îÄ‚îÄ app.e2e-spec.ts
        ‚îÇ       ‚îî‚îÄ‚îÄ jest-e2e.json
        ‚îú‚îÄ‚îÄ extension/
        ‚îÇ   ‚îú‚îÄ‚îÄ background.js
        ‚îÇ   ‚îú‚îÄ‚îÄ content.js
        ‚îÇ   ‚îú‚îÄ‚îÄ manifest.json
        ‚îÇ   ‚îú‚îÄ‚îÄ popup.css
        ‚îÇ   ‚îú‚îÄ‚îÄ popup.html
        ‚îÇ   ‚îî‚îÄ‚îÄ popup.js
        ‚îî‚îÄ‚îÄ frontend/
            ‚îú‚îÄ‚îÄ README.md
            ‚îú‚îÄ‚îÄ eslint.config.mjs
            ‚îú‚îÄ‚îÄ next.config.ts
            ‚îú‚îÄ‚îÄ package.json
            ‚îú‚îÄ‚îÄ postcss.config.js
            ‚îú‚îÄ‚îÄ postcss.config.mjs
            ‚îú‚îÄ‚îÄ tailwind.config.ts
            ‚îú‚îÄ‚îÄ tsconfig.json
            ‚îú‚îÄ‚îÄ app/
            ‚îÇ   ‚îú‚îÄ‚îÄ globals.css
            ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
            ‚îÇ   ‚îú‚îÄ‚îÄ page.module.css
            ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
            ‚îÇ   ‚îú‚îÄ‚îÄ admin/
            ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ users/
            ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
            ‚îÇ   ‚îú‚îÄ‚îÄ app/
            ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth/
            ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ callback/
            ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ page.tsx
            ‚îÇ   ‚îú‚îÄ‚îÄ login/
            ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
            ‚îÇ   ‚îú‚îÄ‚îÄ register/
            ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
            ‚îÇ   ‚îî‚îÄ‚îÄ vocabulary/
            ‚îÇ       ‚îú‚îÄ‚îÄ page.tsx
            ‚îÇ       ‚îî‚îÄ‚îÄ tree.txt
            ‚îî‚îÄ‚îÄ contexts/
                ‚îî‚îÄ‚îÄ AuthContext.tsx

================================================
FILE: AI_CONTEXT.md
================================================
[Empty file]


================================================
FILE: docker-compose.yml
================================================
# c2025-12-09-full-app-english\docker-compose.yml

# --- PH·∫¶N 1: GLOBAL SETTINGS (C√ÄI ƒê·∫∂T CHUNG) ---

# Version: X√°c ƒë·ªãnh 'grammar' (ng·ªØ ph√°p) m√† file n√†y s·ª≠ d·ª•ng.
# Version 3.8 l√† b·∫£n stable (·ªïn ƒë·ªãnh) v√† ph·ªï bi·∫øn nh·∫•t hi·ªán nay.
version: "3.8"

# --- PH·∫¶N 2: SERVICES (C√ÅC ·ª®NG D·ª§NG C·∫¶N CH·∫†Y) ---
# Services l√† tr√°i tim c·ªßa file. N∆°i b·∫°n list ra c√°c 'app' mu·ªën ch·∫°y.
services:
  # === SERVICE 1: DATABASE (POSTGRESQL) ===
  postgres:
    # 1. Image (Source Code):
    # - 'postgres': T√™n ph·∫ßn m·ªÅm tr√™n Docker Hub.
    # - ':15-alpine': Tag phi√™n b·∫£n.
    #   + '15': Version ch√≠nh.
    #   + 'alpine': L√† h·ªá ƒëi·ªÅu h√†nh Linux si√™u nh·ªè (ch·ªâ ~5MB), gi√∫p container nh·∫π v√† b·∫£o m·∫≠t h∆°n.
    image: postgres:15-alpine

    # 2. Container Name (ƒê·ªãnh danh):
    # - N·∫øu kh√¥ng ƒë·∫∑t, Docker s·∫Ω t·ª± random t√™n (vd: project_postgres_1).
    # - ƒê·∫∑t t√™n c·ªë ƒë·ªãnh 'vocab_db' gi√∫p b·∫°n d·ªÖ g√µ l·ªánh (CLI) sau n√†y.
    container_name: vocab_db

    # 3. Environment Variables (Bi·∫øn m√¥i tr∆∞·ªùng):
    # - ƒê√¢y l√† c√°ch ta 'inject' (ti√™m) c·∫•u h√¨nh v√†o trong container l√∫c n√≥ kh·ªüi ƒë·ªông (runtime).
    # - C√°c bi·∫øn b·∫Øt ƒë·∫ßu b·∫±ng 'POSTGRES_...' l√† quy ƒë·ªãnh ri√™ng c·ªßa image Postgres.
    environment:
      POSTGRES_USER: myuser # T·∫°o user m·∫∑c ƒë·ªãnh c√≥ quy·ªÅn cao nh·∫•t (superuser)
      POSTGRES_PASSWORD: mypassword # Set m·∫≠t kh·∫©u cho user ƒë√≥
      POSTGRES_DB: vocab_db # T·ª± ƒë·ªông t·∫°o s·∫µn 1 database r·ªóng t√™n l√† 'vocab_db'

    # 4. Ports Mapping (√Ånh x·∫° c·ªïng - Quan tr·ªçng!):
    # - C√∫ ph√°p: "HOST_PORT : CONTAINER_PORT" (Ngo√†i : Trong).
    # - "5432" (Tr√°i): C·ªïng tr√™n m√°y t√≠nh c·ªßa b·∫°n (Localhost).
    # - "5432" (Ph·∫£i): C·ªïng m·∫∑c ƒë·ªãnh m√† Postgres l·∫Øng nghe b√™n trong container.
    # -> √ù nghƒ©a: B·∫•t c·ª© ai g√µ v√†o 'localhost:5432' tr√™n m√°y b·∫°n s·∫Ω ƒë∆∞·ª£c 'tunnel' (ƒëi ƒë∆∞·ªùng h·∫ßm) th·∫≥ng v√†o database.
    ports:
      - "5433:5432"  # üëà S·ª≠a 5432 th√†nh 5433 (C·ªïng ngo√†i m√°y th·∫≠t : C·ªïng trong docker)

    # 5. Volumes (L∆∞u tr·ªØ d·ªØ li·ªáu):
    # - C√∫ ph√°p: "VOLUME_NAME : CONTAINER_PATH"
    # - 'postgres_data': T√™n c√°i 'k√©t s·∫Øt' (volume) do Docker qu·∫£n l√Ω.
    # - '/var/lib/postgresql/data': ƒê∆∞·ªùng d·∫´n b·∫Øt bu·ªôc n∆°i Postgres l∆∞u file d·ªØ li·ªáu b√™n trong.
    # -> √ù nghƒ©a: Sync (ƒë·ªìng b·ªô) d·ªØ li·ªáu t·ª´ trong ra ngo√†i. Container ch·∫øt, data v·∫´n c√≤n ·ªü 'postgres_data'.
    volumes:
      - postgres_data:/var/lib/postgresql/data

    # 6. Restart Policy (C∆° ch·∫ø t·ª± ph·ª•c h·ªìi):
    # - 'always': N·∫øu container b·ªã crash (l·ªói) ho·∫∑c m√°y t√≠nh kh·ªüi ƒë·ªông l·∫°i,
    #   Docker s·∫Ω t·ª± ƒë·ªông b·∫≠t n√≥ d·∫≠y. Gi·ªØ cho service lu√¥n 'Alive'.
    restart: always

  # === SERVICE 2: REDIS (CACHE / QUEUE) ===
  redis:
    # D√πng image redis b·∫£n nh·∫π nh·∫•t (alpine)
    image: redis:alpine

    # ƒê·∫∑t t√™n ƒë·ªÉ d·ªÖ qu·∫£n l√Ω
    container_name: vocab_redis

    # Mapping c·ªïng Redis.
    # C·ªïng 6379 l√† c·ªïng chu·∫©n c·ªßa Redis.
    ports:
      - "6379:6379"

    # T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i n·∫øu c√≥ s·ª± c·ªë
    restart: always

# --- PH·∫¶N 3: VOLUMES DECLARATION (KHAI B√ÅO KHO CH·ª®A) ---
# B·∫°n ƒë√£ d√πng 'postgres_data' ·ªü tr√™n, n√™n b·∫°n ph·∫£i ƒëƒÉng k√Ω n√≥ ·ªü ƒë√¢y.
volumes:
  postgres_data:
    # M·∫∑c ƒë·ªãnh Docker s·∫Ω t·∫°o volume n√†y ·ªü s√¢u trong h·ªá th·ªëng file c·ªßa Docker
    # (th∆∞·ªùng l√† /var/lib/docker/volumes/...)



================================================
FILE: apps/extension.crx
================================================
[Binary file]


================================================
FILE: apps/extension.pem
================================================
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCrbUhiqOJ58LhD
LHaHpcW8G0IRVgG2xN01/1r72xQzhDxR0zgBDwpOuzSr6Z7ciKAv/6Na0ngp/uLr
t7MqC+ZFdodkSA/62OsGT0HT2i4fP/Tcq1rO2r7a6AWE0p8PmnsHnjHBkc8iJ/He
1ERa2ItBC5pforCelahTiQTftFqv3Oi98MjeMZL4neFngqqnfR24Vy+bUibShLjL
vzDwK65NbPz7FKMdl+8+fcfgpvN0Xh8Bbeq/ZGHNkrcUYYEXIg14JYWctWmeBp5+
0ZB/cG2tZ6LL0HuJy3SwEEghTHLVVb5Uxfma4S1CfoArsSICCTmvgxs5haH600AF
y0C67Rg/AgMBAAECggEAFEWaF8Cs94qV36u0YJoj5fi7OV2YWkqxdh86XSotG2J5
15tItidXKrRMqD+6P44Qk1yBrs3Q0/aGUyWoFELP+krn+93hteJM+LQKrsjQR3XC
uQ2ycV/AzhY+ANT/ZlL4VZBJhgB+JCXhHl6vrqaI4SpEGSceB8Le4vIDF4k2aDFf
sLObfrHGdi/NWxsiB7LFSYCdoxmP1mZkx26cdlRP9LU3ot2Za+gc3i9SMrelwsoJ
VhQyubbl8GNq8IZKROOVscaAhbziqy1PRy/4HviG1OW3m7VJNKYGA3F3KTWdnF0y
J5VGco0farTDvanRHhY62tlzFRzrfA0MmJacJOYI8QKBgQDnnGklNniD05KoeZaR
2BMhxpfNtqqvtYX6wJfDHWHmLjYKs44gOsQDs36raNAjNl8xJH51t0pe1HEn0RI/
ltiCvpd5S7yxjAfGbgMu/Xq+bBYvr48CXOrshrIdDzkqz+uRZgJWxg2LYkBAe81r
ZXuOgHmjs5TQrgfEbllyIatblQKBgQC9ennTRxg4TdztH5Ys7rO+5EYM4KaTUvZQ
Lxz+iihgbtmFEm9QKjFgM/u6sP1yBQ4NxLSAQ/fvC5WXUx/cg/3g9cyZ82Cw7up7
KZrwgZulKpLnI35J4BHLTP5rubiuBoLd0+UQTlViU9meJSsrWciiGOUzILrSuKkb
nJ+ymoGPgwKBgHuTOYqQWJbFkO9xCERCjFquEhrBRqq/aH/UuGRzTeO5bj4hdUh+
8kyjPYeJQdw3y2x18z8tj3GvWbyL0Xe6LUT9Geau4Tu94fwegHZW6mGlW+UPf3cc
Sn/ukiPtFmxgSWjni4Hu5BUlU/DT3VNa7ySmKcCNNW5uHFjTI8hAbKRNAoGBAKYc
rJcEOgCKioe77F2B+0T8PUlm3cJEtjo/w4yHtLQuGjamnb3K77SmficCqX7/XX3G
mHPmooMIReH/duxNLxK8it3g10Dmg9zr8bCt/7UCKP3ISRwc+5ye6GGq1XSDstEk
xinQctycJCmX7ku4D8PETZPQOtkoGOFjI0JiX/lfAoGAMLpVvGf/ncOTVazUAKJU
ZIGexPhTKLVt9F/G/EkRnIBF/TEPcNOJXbsYA0GgJ0qw652chWs34CCquIhk1U4V
z3zM/k5PfbZspGpqT5yatnQz/jwLNAhl2SPL4Xezg6Bx8iQbkmuY66+B/xTdmZBv
sTbdiRavz2sw0XuG5X5CoUQ=
-----END PRIVATE KEY-----



================================================
FILE: apps/tree.txt
================================================
[Binary file]


================================================
FILE: apps/backend/README.md
================================================
<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil My≈õliwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).



================================================
FILE: apps/backend/eslint.config.mjs
================================================
// @ts-check
import eslint from '@eslint/js';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';
import globals from 'globals';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  {
    ignores: ['eslint.config.mjs'],
  },
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  eslintPluginPrettierRecommended,
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.jest,
      },
      sourceType: 'commonjs',
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-floating-promises': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn',
      "prettier/prettier": ["error", { endOfLine: "auto" }],
    },
  },
);



================================================
FILE: apps/backend/nest-cli.json
================================================
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}



================================================
FILE: apps/backend/package.json
================================================
{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.2",
    "@nestjs/mapped-types": "*",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@prisma/client": "^5.10.2",
    "@types/passport-local": "^1.0.38",
    "bcrypt": "^6.0.0",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.3",
    "csv-parser": "^3.2.0",
    "passport": "^0.7.0",
    "passport-google-oauth20": "^2.0.0",
    "passport-jwt": "^4.0.1",
    "passport-local": "^1.0.0",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/bcrypt": "^6.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/multer": "^2.0.0",
    "@types/node": "^22.19.2",
    "@types/passport-google-oauth20": "^2.0.17",
    "@types/passport-jwt": "^4.0.1",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "prisma": "^5.10.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}



================================================
FILE: apps/backend/tree.txt
================================================
backend
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ eslint.config.mjs
‚îú‚îÄ‚îÄ nest-cli.json
‚îú‚îÄ‚îÄ package-lock.json
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ prisma
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ app.controller.spec.ts
‚îÇ   ‚îú‚îÄ‚îÄ app.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ app.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ test
‚îÇ   ‚îú‚îÄ‚îÄ app.e2e-spec.ts
‚îÇ   ‚îî‚îÄ‚îÄ jest-e2e.json
‚îú‚îÄ‚îÄ tree.txt
‚îú‚îÄ‚îÄ tsconfig.build.json
‚îî‚îÄ‚îÄ tsconfig.json



================================================
FILE: apps/backend/tsconfig.build.json
================================================
{
  "extends": "./tsconfig.json",
  "exclude": ["node_modules", "test", "dist", "**/*spec.ts"]
}



================================================
FILE: apps/backend/tsconfig.json
================================================
{
  "compilerOptions": {
    "module": "nodenext",
    "moduleResolution": "nodenext",
    "resolvePackageJsonExports": true,
    "esModuleInterop": true,
    "isolatedModules": true,
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2023",
    "sourceMap": true,
    "outDir": "./dist",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "noFallthroughCasesInSwitch": false
  }
}



================================================
FILE: apps/backend/.prettierrc
================================================
{
  "singleQuote": true,
  "trailingComma": "all"
}



================================================
FILE: apps/backend/prisma/schema.prisma
================================================
// c2025-12-09-full-app-english\apps\backend\prisma\schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. B·∫£ng User (Ng∆∞·ªùi d√πng)
model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String? // üëà Th√™m d·∫•u ? ƒë·ªÉ cho ph√©p Null (User Google kh√¥ng c√≥ pass)
  name     String?
  avatar   String? // üëà Th√™m tr∆∞·ªùng n√†y ƒë·ªÉ l∆∞u ·∫£nh ƒë·∫°i di·ªán t·ª´ Google
  provider String  @default("local") // "local" ho·∫∑c "google"
  googleId String? @unique // ID ri√™ng c·ªßa Google tr·∫£ v·ªÅ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vocabItems VocabItem[]

  @@map("users")
}

// 2. B·∫£ng VocabItem (T·ª´ v·ª±ng)
// apps/backend/prisma/schema.prisma

model VocabItem {
  id String @id @default(uuid())

  // --- C√ÅC C·ªòT KH·ªöP V·ªöI EXCEL ---
  topic         String? // Topic
  word          String // Word (B·∫Øt bu·ªôc)
  partOfSpeech  String? @map("part_of_speech") // Part of speech
  pronunciation String? // Pronunciation
  meaning       String? // Meaning
  example       String? // Example
  relatedWords  String? @map("related_words") // Related words
  occurrence    Int?    @default(1)
  isStarred     Boolean @default(false) // üëà New field: M·∫∑c ƒë·ªãnh l√† false, ƒë√°nh d·∫•u th√¨ true

  // --- C√ÅC C·ªòT H·ªÜ TH·ªêNG (B·∫Øt bu·ªôc ph·∫£i gi·ªØ) ---
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // Map c·ªôt "Time" trong Excel v√†o createdAt
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // X√≥a c√°c tr∆∞·ªùng c≈© kh√¥ng d√πng n·ªØa (imageUrl, audioUrl, tags, masteryLevel...)
  // Ho·∫∑c c·ª© ƒë·ªÉ ƒë√≥ n·∫øu sau n√†y mu·ªën d√πng l·∫°i, nh∆∞ng ·ªü ƒë√¢y m√¨nh x√≥a cho g·ªçn theo √Ω b·∫°n.

  @@index([userId])
  @@map("vocab_items")
}



================================================
FILE: apps/backend/src/app.controller.spec.ts
================================================
import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});



================================================
FILE: apps/backend/src/app.controller.ts
================================================
import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}



================================================
FILE: apps/backend/src/app.module.ts
================================================
// apps/backend/src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PrismaModule } from './prisma/prisma.module';
import { AuthModule } from './modules/auth/auth.module';
import { UsersModule } from './modules/users/users.module';
import { VocabularyModule } from './modules/vocabulary/vocabulary.module';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true, // üëà Quan tr·ªçng!
    }),
    PrismaModule,
    AuthModule,
    UsersModule,
    VocabularyModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}



================================================
FILE: apps/backend/src/app.service.ts
================================================
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}



================================================
FILE: apps/backend/src/main.ts
================================================
import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Enable CORS with credentials
  app.enableCors({
    origin: ['http://localhost:3000', 'http://localhost:3001'], // üëà Th√™m c·∫£ 2 port
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
  });

  // Enable validation
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      transform: true,
    }),
  );

  await app.listen(5000);
  console.log('üöÄ Backend running on http://localhost:5000');
}
bootstrap();


================================================
FILE: apps/backend/src/modules/auth/auth.controller.ts
================================================
import { Controller, Post, Body, Get, UseGuards, Req, Res } from '@nestjs/common';
import { AuthService } from './auth.service';
import { GoogleAuthGuard } from './guards/google-auth.guard';
import { JwtAuthGuard } from './guards/jwt-auth.guard';
import type { Response } from 'express'; // üëà Th√™m "type"

@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @Post('register')
  async register(
    @Body() body: { email: string; password: string; name?: string },
  ) {
    return this.authService.register(body.email, body.password, body.name);
  }

  @Post('login')
  async login(@Body() body: { email: string; password: string }) {
    return this.authService.login(body.email, body.password);
  }

  @Get('google')
  @UseGuards(GoogleAuthGuard)
  async googleAuth() {
    // Redirects to Google
  }

  @Get('google/callback')
  @UseGuards(GoogleAuthGuard)
  async googleAuthRedirect(@Req() req, @Res() res: Response) {
    const result = await this.authService.googleLogin(req.user);

    const frontendUrl = `http://localhost:3000/auth/callback?token=${result.token}`;
    return res.redirect(frontendUrl);
  }

  @Get('me')
  @UseGuards(JwtAuthGuard)
  async getMe(@Req() req) {
    return this.authService.getUserById(req.user.id);
  }
}


================================================
FILE: apps/backend/src/modules/auth/auth.module.ts
================================================
// apps/backend/src/modules/auth/auth.module.ts
import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { PrismaModule } from '../../prisma/prisma.module';
import { LocalStrategy } from './strategies/local.strategy';
import { JwtStrategy } from './strategies/jwt.strategy';
import { GoogleStrategy } from './strategies/google.strategy';

@Module({
  imports: [
    PrismaModule,
    PassportModule,
    ConfigModule,
    JwtModule.registerAsync({
      imports: [ConfigModule],
      useFactory: async (configService: ConfigService) => ({
        secret: configService.get('JWT_SECRET') || 'your-secret-key-change-in-production',
        signOptions: { expiresIn: '7d' },
      }),
      inject: [ConfigService],
    }),
  ],
  controllers: [AuthController],
  providers: [AuthService, LocalStrategy, JwtStrategy, GoogleStrategy],
  exports: [AuthService],
})
export class AuthModule {}


================================================
FILE: apps/backend/src/modules/auth/auth.service.ts
================================================
// apps/backend/src/modules/auth/auth.service.ts

import { Injectable, UnauthorizedException, ConflictException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../../prisma/prisma.service';
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
  constructor(
    private prisma: PrismaService,
    private jwtService: JwtService,
  ) {}

  // ========== REGISTER WITH EMAIL/PASSWORD ==========
  async register(email: string, password: string, name?: string) {
    // Check if user exists
    const existingUser = await this.prisma.user.findUnique({
      where: { email },
    });

    if (existingUser) {
      throw new ConflictException('Email already exists');
    }

    // Hash password
    const hashedPassword = await bcrypt.hash(password, 10);

    // Create user
    const user = await this.prisma.user.create({
      data: {
        email,
        password: hashedPassword,
        name: name || email.split('@')[0], // Default name from email
        provider: 'local',
      },
    });

    // Generate token
    const token = this.generateToken(user.id, user.email);

    return {
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        avatar: user.avatar,
      },
      token,
    };
  }

  // ========== LOGIN WITH EMAIL/PASSWORD ==========
  async login(email: string, password: string) {
    // Find user
    const user = await this.prisma.user.findUnique({
      where: { email },
    });

    if (!user || !user.password) {
      throw new UnauthorizedException('Invalid credentials');
    }

    // Check password
    const isPasswordValid = await bcrypt.compare(password, user.password);

    if (!isPasswordValid) {
      throw new UnauthorizedException('Invalid credentials');
    }

    // Generate token
    const token = this.generateToken(user.id, user.email);

    return {
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        avatar: user.avatar,
      },
      token,
    };
  }

  // ========== GOOGLE OAUTH LOGIN ==========
  async googleLogin(googleUser: {
    email: string;
    firstName: string;
    lastName: string;
    picture: string;
    googleId: string;
  }) {
    // Check if user exists
    let user = await this.prisma.user.findUnique({
      where: { email: googleUser.email },
    });

    if (!user) {
      // Create new user from Google
      user = await this.prisma.user.create({
        data: {
          email: googleUser.email,
          name: `${googleUser.firstName} ${googleUser.lastName}`,
          avatar: googleUser.picture,
          provider: 'google',
          googleId: googleUser.googleId,
          password: null, // Google users don't have password
        },
      });
    } else if (user.provider === 'local') {
      // Link Google to existing local account
      user = await this.prisma.user.update({
        where: { id: user.id },
        data: {
          googleId: googleUser.googleId,
          avatar: googleUser.picture, // Update avatar
        },
      });
    }

    // Generate token
    const token = this.generateToken(user.id, user.email);

    return {
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        avatar: user.avatar,
      },
      token,
    };
  }

  // ========== VALIDATE USER (For Passport) ==========
  async validateUser(email: string, password: string): Promise<any> {
    const user = await this.prisma.user.findUnique({
      where: { email },
    });

    if (user && user.password) {
      const isPasswordValid = await bcrypt.compare(password, user.password);
      if (isPasswordValid) {
        const { password, ...result } = user;
        return result;
      }
    }
    return null;
  }

  // ========== GET USER BY ID ==========
  async getUserById(id: string) {
    const user = await this.prisma.user.findUnique({
      where: { id },
      select: {
        id: true,
        email: true,
        name: true,
        avatar: true,
        provider: true,
        createdAt: true,
      },
    });

    if (!user) {
      throw new UnauthorizedException('User not found');
    }

    return user;
  }

  // ========== HELPER: GENERATE JWT TOKEN ==========
  private generateToken(userId: string, email: string) {
    return this.jwtService.sign({
      sub: userId,
      email,
    });
  }
}


================================================
FILE: apps/backend/src/modules/auth/dto/create-auth.dto.ts
================================================
export class CreateAuthDto {}



================================================
FILE: apps/backend/src/modules/auth/dto/update-auth.dto.ts
================================================
import { PartialType } from '@nestjs/mapped-types';
import { CreateAuthDto } from './create-auth.dto';

export class UpdateAuthDto extends PartialType(CreateAuthDto) {}



================================================
FILE: apps/backend/src/modules/auth/entities/auth.entity.ts
================================================
export class Auth {}



================================================
FILE: apps/backend/src/modules/auth/guards/google-auth.guard.ts
================================================
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class GoogleAuthGuard extends AuthGuard('google') {}


================================================
FILE: apps/backend/src/modules/auth/guards/jwt-auth.guard.ts
================================================
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}



================================================
FILE: apps/backend/src/modules/auth/guards/local-auth.guard.ts
================================================
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class LocalAuthGuard extends AuthGuard('local') {}



================================================
FILE: apps/backend/src/modules/auth/strategies/google.strategy.ts
================================================
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy, VerifyCallback, Profile, StrategyOptions } from 'passport-google-oauth20';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class GoogleStrategy extends PassportStrategy(Strategy, 'google') {
  constructor(private configService: ConfigService) {
    super({
      clientID: configService.get<string>('GOOGLE_CLIENT_ID') || '',
      clientSecret: configService.get<string>('GOOGLE_CLIENT_SECRET') || '',
      callbackURL: 'http://localhost:5000/auth/google/callback',
      scope: ['email', 'profile'],
    } as StrategyOptions); // üëà Th√™m "as StrategyOptions"
  }

  async validate(
    accessToken: string,
    refreshToken: string,
    profile: Profile,
    done: VerifyCallback,
  ): Promise<any> {
    const { name, emails, photos, id } = profile;
    
    const user = {
      email: emails?.[0]?.value || '',
      firstName: name?.givenName || '',
      lastName: name?.familyName || '',
      picture: photos?.[0]?.value || '',
      googleId: id,
    };

    done(null, user);
  }
}


================================================
FILE: apps/backend/src/modules/auth/strategies/jwt.strategy.ts
================================================
// apps/backend/src/modules/auth/strategies/jwt.strategy.ts
import { ExtractJwt, Strategy } from 'passport-jwt';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(private configService: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: configService.get('JWT_SECRET') || 'your-secret-key-change-in-production',
    });
  }

  async validate(payload: any) {
    return { 
      id: payload.sub, 
      email: payload.email 
    };
  }
}


================================================
FILE: apps/backend/src/modules/auth/strategies/local.strategy.ts
================================================
// apps/backend/src/modules/auth/strategies/local.strategy.ts
import { Strategy } from 'passport-local';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { AuthService } from '../auth.service';

@Injectable()
export class LocalStrategy extends PassportStrategy(Strategy) {
  constructor(private authService: AuthService) {
    super({
      usernameField: 'email', // M·∫∑c ƒë·ªãnh l√† 'username', m√¨nh ƒë·ªïi th√†nh 'email' cho ƒë√∫ng project
    });
  }

  // H√†m n√†y s·∫Ω t·ª± ƒë·ªông ch·∫°y khi user login
  async validate(email: string, pass: string): Promise<any> {
    const user = await this.authService.validateUser(email, pass);
    if (!user) {
      throw new UnauthorizedException('Sai email ho·∫∑c m·∫≠t kh·∫©u');
    }
    return user;
  }
}



================================================
FILE: apps/backend/src/modules/users/users.controller.ts
================================================
import { Controller, Post, Body } from '@nestjs/common';
import { UsersService } from './users.service';
import { CreateUserDto } from './dto/create-user.dto';

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return this.usersService.create(createUserDto);
  }

  // T·∫°m th·ªùi b·ªè c√°c route findAll, findOne, update, remove 
  // v√¨ Service ch∆∞a implement logic ƒë√≥.
}


================================================
FILE: apps/backend/src/modules/users/users.module.ts
================================================
import { Module } from '@nestjs/common';
import { UsersService } from './users.service';
import { UsersController } from './users.controller';

@Module({
  controllers: [UsersController],
  providers: [UsersService],
  exports: [UsersService],
})
export class UsersModule {}



================================================
FILE: apps/backend/src/modules/users/users.service.ts
================================================
import { Injectable } from '@nestjs/common';
import { CreateUserDto } from './dto/create-user.dto';
import { PrismaService } from '../../prisma/prisma.service'; // Import global service
import * as bcrypt from 'bcrypt';

@Injectable()
export class UsersService {
  constructor(private prisma: PrismaService) {}

  async create(createUserDto: CreateUserDto) {
    const { email, password, name } = createUserDto;
    // Hash password logic
    const hashedPassword = password ? await bcrypt.hash(password, 10) : null;

    return this.prisma.user.create({
      data: {
        email,
        password: hashedPassword,
        name,
      },
    });
  }

  // Find user for Auth logic
  async findOneByEmail(email: string) {
    return this.prisma.user.findUnique({
      where: { email },
    });
  }
}



================================================
FILE: apps/backend/src/modules/users/dto/create-user.dto.ts
================================================
export class CreateUserDto {
  email: string;
  password?: string; // Optional v√¨ sau n√†y c√≥ th·ªÉ login b·∫±ng Google
  name?: string;
}



================================================
FILE: apps/backend/src/modules/users/dto/update-user.dto.ts
================================================
import { PartialType } from '@nestjs/mapped-types';
import { CreateUserDto } from './create-user.dto';

export class UpdateUserDto extends PartialType(CreateUserDto) {}



================================================
FILE: apps/backend/src/modules/users/entities/user.entity.ts
================================================
export class User {}



================================================
FILE: apps/backend/src/modules/vocabulary/vocabulary.controller.ts
================================================
import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  UseGuards,
  Request,
  UseInterceptors,
  UploadedFile,
  Query, // üëà ƒê·∫£m b·∫£o ƒë√£ import Query
} from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { VocabularyService } from './vocabulary.service';
import { CreateVocabularyDto } from './dto/create-vocabulary.dto';
import { UpdateVocabularyDto } from './dto/update-vocabulary.dto';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';

@Controller('vocabulary')
@UseGuards(JwtAuthGuard)
export class VocabularyController {
  constructor(private readonly vocabularyService: VocabularyService) {}

  @Post()
  create(@Request() req, @Body() createDto: CreateVocabularyDto) {
    return this.vocabularyService.create(req.user.id, createDto);
  }

  @Post('import/csv')
  @UseInterceptors(FileInterceptor('file'))
  async importCsv(
    @Request() req,
    @UploadedFile() file: Express.Multer.File,
  ) {
    return this.vocabularyService.importFromCsv(req.user.id, file);
  }

  // üëá C·∫¨P NH·∫¨T H√ÄM FIND ALL
  @Get()
  findAll(
    @Request() req,
    @Query('page') page: string,
    @Query('limit') limit: string,
    // üëá Th√™m l·∫°i tham s·ªë search chung (Quick Search d√πng c√°i n√†y)
    @Query('search') search: string,
    // C√°c Filter Params
    @Query('word') word: string,
    @Query('topic') topic: string,
    @Query('partOfSpeech') partOfSpeech: string,
    @Query('meaning') meaning: string,
    // üëá Sort Params (M·ªõi th√™m)
    @Query('sortBy') sortBy: string,
    @Query('sortOrder') sortOrder: string,
  ) {
    const pageNumber = page ? parseInt(page) : 1;
    const limitNumber = limit ? parseInt(limit) : 20;

    // Gom c√°c filter
    const filters = { word, topic, partOfSpeech, meaning };

    // T·∫°o object sort
    const sort = {
      field: sortBy || 'createdAt', // Default field l√† ng√†y t·∫°o
      order: (sortOrder === 'asc' ? 'asc' : 'desc') as 'asc' | 'desc', // Default order l√† gi·∫£m d·∫ßn (desc)
    };

    // üëá G·ªçi h√†m Service v·ªõi ƒê·ª¶ 5 THAM S·ªê
    return this.vocabularyService.findAll(
      req.user.id,
      pageNumber,
      limitNumber,
      filters,
      sort,
      search // üëà Quan tr·ªçng: Truy·ªÅn search xu·ªëng service
    );
  }

  @Get(':id')
  findOne(@Request() req, @Param('id') id: string) {
    return this.vocabularyService.findOne(id, req.user.id);
  }

  @Patch(':id')
  update(
    @Request() req,
    @Param('id') id: string,
    @Body() updateDto: UpdateVocabularyDto,
  ) {
    return this.vocabularyService.update(id, req.user.id, updateDto);
  }

  @Delete(':id')
  remove(@Request() req, @Param('id') id: string) {
    return this.vocabularyService.remove(id, req.user.id);
  }
}


================================================
FILE: apps/backend/src/modules/vocabulary/vocabulary.module.ts
================================================
// apps/backend/src/modules/vocabulary/vocabulary.module.ts
import { Module } from '@nestjs/common';
import { VocabularyService } from './vocabulary.service';
import { VocabularyController } from './vocabulary.controller';
import { PrismaModule } from '../../prisma/prisma.module';

@Module({
  imports: [PrismaModule],
  controllers: [VocabularyController],
  providers: [VocabularyService],
})
export class VocabularyModule {}


================================================
FILE: apps/backend/src/modules/vocabulary/vocabulary.service.ts
================================================
// apps/backend/src/modules/vocabulary/vocabulary.service.ts

import {
  Injectable,
  NotFoundException,
  BadRequestException,
} from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { Prisma } from '@prisma/client';
import { CreateVocabularyDto } from './dto/create-vocabulary.dto';
import { UpdateVocabularyDto } from './dto/update-vocabulary.dto';
import csv from 'csv-parser'; // Lib ƒë·ªçc CSV
import { Readable } from 'stream'; // Lib c√≥ s·∫µn c·ªßa Node.js

// üëá Define Interface cho c√°c filter parameters
interface VocabFilters {
  word?: string;
  topic?: string;
  partOfSpeech?: string;
  meaning?: string;
}

@Injectable()
export class VocabularyService {
  constructor(private prisma: PrismaService) {}

  // --- 1. CREATE ---
  async create(userId: string, createDto: CreateVocabularyDto) {
    return this.prisma.vocabItem.create({
      data: {
        ...createDto,
        userId,
      },
    });
  }

  // --- 2. FIND ALL (Search + Filter + Sort + Pagination) ---
  async findAll(
    userId: string,
    page: number = 1,
    limit: number = 20,
    filters: VocabFilters = {},
    sort: { field: string; order: 'asc' | 'desc' } = {
      field: 'createdAt',
      order: 'desc',
    }, // Default sort
    search?: string, // üëà Global Search param
  ) {
    const skip = (page - 1) * limit;

    // Helper clean text
    const clean = (text?: string) => text?.trim();

    // üëá X√¢y d·ª±ng c√¢u query (Where Condition)
    const whereCondition: Prisma.VocabItemWhereInput = {
      userId, // Lu√¥n filter theo user hi·ªán t·∫°i

      // 1. C√°c b·ªô l·ªçc ri√™ng l·∫ª (AND logic)
      word: filters.word
        ? { contains: clean(filters.word), mode: 'insensitive' }
        : undefined,
      topic: filters.topic
        ? { contains: clean(filters.topic), mode: 'insensitive' }
        : undefined,
      partOfSpeech: filters.partOfSpeech
        ? { contains: clean(filters.partOfSpeech), mode: 'insensitive' }
        : undefined,
      meaning: filters.meaning
        ? { contains: clean(filters.meaning), mode: 'insensitive' }
        : undefined,

      // 2. Global Search (OR logic)
      // N·∫øu c√≥ bi·∫øn 'search', t√¨m n√≥ trong Word HO·∫∂C Meaning HO·∫∂C Topic
      ...(search
        ? {
            OR: [
              { word: { contains: clean(search), mode: 'insensitive' } },
              { meaning: { contains: clean(search), mode: 'insensitive' } },
              { topic: { contains: clean(search), mode: 'insensitive' } },
            ],
          }
        : {}),
    };

    // üëá X√¢y d·ª±ng Sort (Order By)
    const orderByInput: Prisma.VocabItemOrderByWithRelationInput[] = [];

    if (sort.field) {
      orderByInput.push({ [sort.field]: sort.order });
    }
    // Lu√¥n add th√™m id ƒë·ªÉ ƒë·∫£m b·∫£o th·ª© t·ª± ·ªïn ƒë·ªãnh (Stable Sort)
    orderByInput.push({ id: 'asc' });

    // üëá Execute Query
    const [items, total] = await Promise.all([
      this.prisma.vocabItem.findMany({
        where: whereCondition,
        skip: skip,
        take: limit,
        orderBy: orderByInput,
      }),
      this.prisma.vocabItem.count({ where: whereCondition }),
    ]);

    return {
      data: items,
      meta: {
        total,
        page,
        lastPage: Math.ceil(total / limit),
      },
    };
  }

  // --- 3. FIND ONE ---
  async findOne(id: string, userId: string) {
    const vocab = await this.prisma.vocabItem.findFirst({
      where: { id, userId },
    });

    if (!vocab) {
      throw new NotFoundException('Vocabulary not found');
    }
    return vocab;
  }

  // --- 4. UPDATE ---
  async update(id: string, userId: string, updateDto: UpdateVocabularyDto) {
    await this.findOne(id, userId); // Check exist
    return this.prisma.vocabItem.update({
      where: { id },
      data: updateDto,
    });
  }

  // --- 5. REMOVE ---
  async remove(id: string, userId: string) {
    await this.findOne(id, userId); // Check exist
    return this.prisma.vocabItem.delete({
      where: { id },
    });
  }
  // apps/backend/src/modules/vocabulary/vocabulary.service.ts

  // Update h√†m create ho·∫∑c t·∫°o m·ªôt h√†m m·ªõi l√† `upsertVocab`
  async upsertVocab(userId: string, createDto: CreateVocabularyDto) {
    // 1. Check if word exists for this user (Case insensitive)
    const existing = await this.prisma.vocabItem.findFirst({
      where: {
        userId,
        word: {
          equals: createDto.word.trim(),
          mode: 'insensitive', // Ignore case (hello == Hello)
        },
      },
    });

    if (existing) {
      // 2. Scenario: Word exists -> Update status & increment occurrence
      return this.prisma.vocabItem.update({
        where: { id: existing.id },
        data: {
          isStarred: true, // Force star
          occurrence: (existing.occurrence || 0) + 1,
          // Optional: Update meaning/example n·∫øu user g·ª≠i c√°i m·ªõi l√™n
        },
      });
    } else {
      // 3. Scenario: Word not found -> Create new full record
      return this.prisma.vocabItem.create({
        data: {
          ...createDto,
          userId,
          isStarred: true, // Auto star khi add t·ª´ extension
        },
      });
    }
  }
  // --- 6. IMPORT CSV ---
  async importFromCsv(userId: string, file: Express.Multer.File) {
    if (!file) {
      throw new BadRequestException('File is required');
    }

    const results: any[] = [];
    const stream = Readable.from(file.buffer.toString());

    return new Promise((resolve, reject) => {
      stream
        .pipe(csv())
        .on('data', (data) => results.push(data))
        .on('end', async () => {
          console.log(`üìÇ Parsed ${results.length} rows from CSV`);

          let successCount = 0;
          let errorCount = 0;

          for (const row of results) {
            try {
              // Mapping c·ªôt trong CSV sang Database
              await this.prisma.vocabItem.create({
                data: {
                  userId: userId,
                  word: row['Word']?.trim(),
                  topic: row['Topic']?.trim(),
                  partOfSpeech: row['Part of speech']?.trim(),
                  pronunciation: row['Pronunciation']?.trim(),
                  meaning: row['Meaning']?.trim(),
                  example: row['Example']?.trim(),
                  relatedWords: row['Related words']?.trim(),
                  occurrence: row['Occurrence']
                    ? parseInt(row['Occurrence'])
                    : 1,
                },
              });
              successCount++;
            } catch (error) {
              errorCount++;
            }
          }

          resolve({
            message: 'Import finished',
            total: results.length,
            success: successCount,
            failed: errorCount,
          });
        })
        .on('error', (error) => {
          reject(new BadRequestException('Invalid CSV file'));
        });
    });
  }
}



================================================
FILE: apps/backend/src/modules/vocabulary/dto/create-vocabulary.dto.ts
================================================
import {
  IsBoolean,
  IsString,
  IsOptional,
  IsInt,
  Min, // Minimum value
} from 'class-validator';

export class CreateVocabularyDto {
  // Field n√†y b·∫Øt bu·ªôc (Required), ph·∫£i l√† String
  @IsString()
  word: string;

  // M·∫•y c√°i d∆∞·ªõi n√†y l√† Optional (c√≥ c≈©ng ƒë∆∞·ª£c, kh√¥ng c√≥ c≈©ng kh√¥ng sao)
  @IsOptional()
  @IsString()
  topic?: string;

  @IsOptional()
  @IsString()
  partOfSpeech?: string; // Lo·∫°i t·ª´ (noun, verb...)

  @IsOptional()
  @IsString()
  pronunciation?: string;

  @IsOptional()
  @IsString()
  meaning?: string;

  @IsOptional()
  @IsString()
  example?: string;

  @IsOptional()
  @IsString()
  relatedWords?: string;

  @IsOptional()
  @IsInt() // Ph·∫£i l√† s·ªë nguy√™n (Integer)
  @Min(0) // Gi√° tr·ªã nh·ªè nh·∫•t l√† 0
  occurrence?: number;

  @IsOptional()
  @IsBoolean()
  isStarred?: boolean; // üëà Add this property
}



================================================
FILE: apps/backend/src/modules/vocabulary/dto/update-vocabulary.dto.ts
================================================
// apps\backend\src\modules\vocabulary\dto\update-vocabulary.dto.ts
import { PartialType } from '@nestjs/mapped-types';
import { CreateVocabularyDto } from './create-vocabulary.dto';

export class UpdateVocabularyDto extends PartialType(CreateVocabularyDto) {}


================================================
FILE: apps/backend/src/modules/vocabulary/entities/vocabulary.entity.ts
================================================
export class Vocabulary {}



================================================
FILE: apps/backend/src/prisma/prisma.module.ts
================================================
import { Global, Module } from '@nestjs/common';
import { PrismaService } from './prisma.service';

@Global() // Key concept: Make it global!
@Module({
  providers: [PrismaService],
  exports: [PrismaService], // Export to use in other modules
})
export class PrismaModule {}



================================================
FILE: apps/backend/src/prisma/prisma.service.ts
================================================
import { Injectable, OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService
  extends PrismaClient
  implements OnModuleInit, OnModuleDestroy
{
  async onModuleInit() {
    await this.$connect();
    console.log('‚úÖ DB Connected via Prisma');
  }

  async onModuleDestroy() {
    await this.$disconnect();
  }
}



================================================
FILE: apps/backend/test/app.e2e-spec.ts
================================================
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { App } from 'supertest/types';
import { AppModule } from './../src/app.module';

describe('AppController (e2e)', () => {
  let app: INestApplication<App>;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/ (GET)', () => {
    return request(app.getHttpServer())
      .get('/')
      .expect(200)
      .expect('Hello World!');
  });
});



================================================
FILE: apps/backend/test/jest-e2e.json
================================================
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}



================================================
FILE: apps/extension/background.js
================================================
// Setup Alarm khi Extension ƒë∆∞·ª£c Installed
chrome.runtime.onInstalled.addListener(() => {
  console.log("Extension Installed. Setting up alarms...");
  // T·∫°o alarm t√™n 'vocab_review' ch·∫°y m·ªói 15 ph√∫t
  chrome.alarms.create("vocab_review", {
    periodInMinutes: 5,
  });
});

// L·∫Øng nghe Alarm trigger
chrome.alarms.onAlarm.addListener((alarm) => {
  if (alarm.name === "vocab_review") {
    // T√¨m tab ƒëang active ƒë·ªÉ g·ª≠i message hi·ªÉn th·ªã Flashcard
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      if (tabs[0]) {
        chrome.tabs.sendMessage(tabs[0].id, {
          action: "SHOW_FLASHCARD",
        });
      }
    });
  }
});



================================================
FILE: apps/extension/content.js
================================================
let popup = null;
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let isSoundEnabled = true;
let isPopupOpen = false;
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let lastRecordedBlob = null; // Bi·∫øn l∆∞u file ghi √¢m g·∫ßn nh·∫•t
// L∆∞u t·ª´ v·ª±ng v√†o l·ªãch s·ª≠ (ƒë·ªÉ hi·ªán Flashcard sau n√†y)
async function saveToHistory(word, data) {
  try {
    const result = await chrome.storage.local.get(["vocabHistory"]);
    let history = result.vocabHistory || [];
    history = history.filter(
      (item) =>
        item && item.word && item.word.toLowerCase() !== word.toLowerCase()
    );
    history.unshift({
      word: word,
      data: data,
      timestamp: Date.now(),
    });
    if (history.length > 50) history.pop();
    await chrome.storage.local.set({ vocabHistory: history });
  } catch (e) {
    console.warn("L·ªói khi l∆∞u l·ªãch s·ª≠:", e);
  }
}

// L·∫•y d·ªØ li·ªáu t·ª´ Cache (RAM/Storage)
async function getFromCache(key) {
  const storageKey = `cache_${key.toLowerCase().trim()}`;
  const result = await chrome.storage.local.get([storageKey]);
  const cachedItem = result[storageKey];

  // Cache h·∫øt h·∫°n sau 24h
  if (cachedItem && Date.now() - cachedItem.timestamp < 24 * 60 * 60 * 1000) {
    console.log(`‚ö° Hit Cache for: ${key}`);
    return cachedItem.data;
  }
  return null;
}

// L∆∞u data m·ªõi v√†o Cache
async function saveToCache(key, data) {
  const storageKey = `cache_${key.toLowerCase().trim()}`;
  await chrome.storage.local.set({
    [storageKey]: {
      data: data,
      timestamp: Date.now(),
    },
  });
}
// T·∫°o popup
function createPopup() {
  if (popup) {
    popup.remove();
  }

  popup = document.createElement("div");
  popup.id = "tts-popup";
  popup.style.display = "none";
  document.body.appendChild(popup);

  return popup;
}

// ƒê√≥ng popup v√† d·ª´ng √¢m thanh
function closePopup() {
  if (popup) {
    popup.style.display = "none";
  }
  speechSynthesis.cancel();
  isPopupOpen = false;
}

// L·∫•y nghƒ©a ti·∫øng Vi·ªát t·ª´ Google Translate
// --- 2. UPDATED TRANSLATION (WITH CONTEXT) ---
// --- 2. TRANSLATION (SAFE MODE) ---
// --- 2. TRANSLATION (DICTIONARY MODE) ---
async function getTranslation(text, contextText = "") {
  try {
    let contextMeaning = null;

    // 1. D·ªãch ng·ªØ c·∫£nh (gi·ªØ nguy√™n logic c≈©)
    if (
      contextText &&
      contextText.length > 0 &&
      contextText.length < 500 &&
      contextText !== text
    ) {
      try {
        const urlContext = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURIComponent(
          contextText
        )}`;
        const resCtx = await fetch(urlContext);
        if (resCtx.ok) {
          const dataCtx = await resCtx.json();
          if (dataCtx && dataCtx[0]) {
            contextMeaning = dataCtx[0].map((item) => item[0]).join("");
          }
        }
      } catch (e) {
        /* Ignore context error */
      }
    }

    // 2. D·ªãch t·ª´ kh√≥a & L·∫•y T·ª´ ƒëi·ªÉn (TH√äM &dt=bd)
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&dt=bd&q=${encodeURIComponent(
      text
    )}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error("Google API Error");

    const data = await response.json();

    if (data) {
      // L·∫•y nghƒ©a ch√≠nh (nh∆∞ c≈©)
      const mainMeaning = data[0]
        ? data[0].map((item) => item[0]).join("")
        : "";

      // L·∫•y d·ªØ li·ªáu t·ª´ ƒëi·ªÉn (Noun, Verb...) - QUAN TR·ªåNG
      let dict = [];
      if (data[1]) {
        data[1].forEach((group) => {
          dict.push({
            pos: group[0], // noun, verb, adjective...
            terms: group[1].slice(0, 5), // L·∫•y top 5 nghƒ©a
          });
        });
      }

      return {
        wordMeaning: mainMeaning,
        contextMeaning: contextMeaning,
        dict: dict, // Tr·∫£ v·ªÅ th√™m t·ª´ ƒëi·ªÉn
      };
    }
  } catch (error) {
    console.error("Translation Error:", error);
    return null;
  }
  return null;
}

// --- LOGIC M·ªöI: FALLBACK SYSTEM ---

// H√†m helper ƒë·ªÉ g·ªçi Google API ƒë∆°n l·∫ª
async function tryFetchGoogleImage(searchTerm, apiKey, cx) {
  try {
    const url = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(
      searchTerm
    )}&cx=${cx}&searchType=image&key=${apiKey}&num=3`;

    const response = await fetch(url);

    // N·∫øu h·∫øt quota (403) ho·∫∑c qu√° t·∫£i (429) -> Throw error ƒë·ªÉ loop b·∫Øt ƒë∆∞·ª£c
    if (response.status === 403 || response.status === 429) {
      throw new Error(`QUOTA_EXCEEDED`);
    }

    if (!response.ok) return null; // L·ªói kh√°c th√¨ return null lu√¥n

    const data = await response.json();
    if (data.items && data.items.length > 0) {
      return data.items.slice(0, 3).map((item) => item.link);
    }
  } catch (e) {
    if (e.message === "QUOTA_EXCEEDED") throw e; // N√©m ti·∫øp ra ngo√†i
    console.warn("Google Fetch Error:", e);
  }
  return null;
}

// H√†m ch√≠nh: Loop qua danh s√°ch Key
async function getImages(englishText) {
  const searchTerm = englishText.trim();
  let images = [];

  // 1. L·∫•y Settings
  const result = await chrome.storage.sync.get([
    "googleApiKeys",
    "googleApiKey",
    "googleSearchEngineId",
  ]); // L·∫•y c·∫£ key c≈© v√† m·ªõi ƒë·ªÉ t∆∞∆°ng th√≠ch

  // Convert c·∫•u tr√∫c c≈© sang list n·∫øu ch∆∞a c√≥ list
  let keyList = result.googleApiKeys || [];
  if (
    keyList.length === 0 &&
    result.googleApiKey &&
    result.googleSearchEngineId
  ) {
    keyList.push({ key: result.googleApiKey, cx: result.googleSearchEngineId });
  }

  // 2. Th·ª≠ Google Custom Search (Loop Fallback)
  if (keyList.length > 0) {
    for (let i = 0; i < keyList.length; i++) {
      const { key, cx } = keyList[i];
      if (!key || !cx) continue;

      try {
        console.log(`Trying Google Key #${i + 1}...`);
        const resultImages = await tryFetchGoogleImage(searchTerm, key, cx);

        if (resultImages && resultImages.length > 0) {
          images = resultImages;
          console.log(`‚úÖ Success with Key #${i + 1}`);
          break; // T√¨m th·∫•y ·∫£nh th√¨ tho√°t v√≤ng l·∫∑p ngay
        }
      } catch (err) {
        if (err.message === "QUOTA_EXCEEDED") {
          console.warn(
            `‚ö†Ô∏è Key #${i + 1} h·∫øt quota. ƒêang chuy·ªÉn sang Key ti·∫øp theo...`
          );
          continue; // Chuy·ªÉn sang key ti·∫øp theo trong v√≤ng l·∫∑p
        }
      }
    }
  }

  // 3. N·∫øu t·∫•t c·∫£ Google Keys ƒë·ªÅu t·∫°ch -> D√πng Unsplash (Last Resort)
  if (images.length === 0) {
    console.log("‚ö†Ô∏è All Google Keys failed or empty. Switching to Unsplash...");
    images = await getImagesFromUnsplash(searchTerm);
  }

  return images;
}
// L·∫•y 3 h√¨nh ·∫£nh t·ª´ Unsplash API
async function getImagesFromUnsplash(searchTerm) {
  try {
    const response = await fetch(
      `https://api.unsplash.com/search/photos?query=${encodeURIComponent(
        searchTerm
      )}&per_page=3&client_id=E8nbwS_cEWGVX4rM0e_-Eq6IpI_QKlO4eFEKfOl3AUo`
    );

    if (response.ok) {
      const data = await response.json();
      if (data.results && data.results.length > 0) {
        return data.results.map((item) => item.urls.regular);
      }
    }
  } catch (error) {
    console.error("Error fetching Unsplash images:", error);
  }

  return [];
}

// --- LOGIC M·ªöI: FALLBACK SYSTEM ---

// H√†m helper ƒë·ªÉ g·ªçi Google API ƒë∆°n l·∫ª
async function tryFetchGoogleImage(searchTerm, apiKey, cx) {
  try {
    const url = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(
      searchTerm
    )}&cx=${cx}&searchType=image&key=${apiKey}&num=3`;

    const response = await fetch(url);

    // N·∫øu h·∫øt quota (403) ho·∫∑c qu√° t·∫£i (429) -> Throw error ƒë·ªÉ loop b·∫Øt ƒë∆∞·ª£c
    if (response.status === 403 || response.status === 429) {
      throw new Error(`QUOTA_EXCEEDED`);
    }

    if (!response.ok) return null; // L·ªói kh√°c th√¨ return null lu√¥n

    const data = await response.json();
    if (data.items && data.items.length > 0) {
      return data.items.slice(0, 3).map((item) => item.link);
    }
  } catch (e) {
    if (e.message === "QUOTA_EXCEEDED") throw e; // N√©m ti·∫øp ra ngo√†i
    console.warn("Google Fetch Error:", e);
  }
  return null;
}

// H√†m ch√≠nh: Loop qua danh s√°ch Key
async function getImages(englishText) {
  const searchTerm = englishText.trim();
  let images = [];

  // 1. L·∫•y Settings
  const result = await chrome.storage.sync.get([
    "googleApiKeys",
    "googleApiKey",
    "googleSearchEngineId",
  ]); // L·∫•y c·∫£ key c≈© v√† m·ªõi ƒë·ªÉ t∆∞∆°ng th√≠ch

  // Convert c·∫•u tr√∫c c≈© sang list n·∫øu ch∆∞a c√≥ list
  let keyList = result.googleApiKeys || [];
  if (
    keyList.length === 0 &&
    result.googleApiKey &&
    result.googleSearchEngineId
  ) {
    keyList.push({ key: result.googleApiKey, cx: result.googleSearchEngineId });
  }

  // 2. Th·ª≠ Google Custom Search (Loop Fallback)
  if (keyList.length > 0) {
    for (let i = 0; i < keyList.length; i++) {
      const { key, cx } = keyList[i];
      if (!key || !cx) continue;

      try {
        console.log(`Trying Google Key #${i + 1}...`);
        const resultImages = await tryFetchGoogleImage(searchTerm, key, cx);

        if (resultImages && resultImages.length > 0) {
          images = resultImages;
          console.log(`‚úÖ Success with Key #${i + 1}`);
          break; // T√¨m th·∫•y ·∫£nh th√¨ tho√°t v√≤ng l·∫∑p ngay
        }
      } catch (err) {
        if (err.message === "QUOTA_EXCEEDED") {
          console.warn(
            `‚ö†Ô∏è Key #${i + 1} h·∫øt quota. ƒêang chuy·ªÉn sang Key ti·∫øp theo...`
          );
          continue; // Chuy·ªÉn sang key ti·∫øp theo trong v√≤ng l·∫∑p
        }
      }
    }
  }

  // 3. N·∫øu t·∫•t c·∫£ Google Keys ƒë·ªÅu t·∫°ch -> D√πng Unsplash (Last Resort)
  if (images.length === 0) {
    console.log("‚ö†Ô∏è All Google Keys failed or empty. Switching to Unsplash...");
    images = await getImagesFromUnsplash(searchTerm);
  }

  return images;
}

// L·∫•y phi√™n √¢m c·ªßa m·ªôt t·ª´
async function getPhoneticForWord(word) {
  try {
    const response = await fetch(
      `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(
        word.trim()
      )}`
    );
    if (!response.ok) return null;

    const data = await response.json();
    if (data && data[0]) {
      const result = {
        uk: null,
        us: null,
      };

      data[0].phonetics?.forEach((p) => {
        if (p.text) {
          if (p.audio && p.audio.includes("-uk")) {
            result.uk = p.text;
          } else if (p.audio && p.audio.includes("-us")) {
            result.us = p.text;
          } else if (!result.us && !result.uk) {
            result.us = p.text;
          }
        }
      });

      if (!result.uk && !result.us && data[0].phonetic) {
        result.us = data[0].phonetic;
      }

      return result;
    }
  } catch (error) {
    console.error("Error fetching phonetic:", error);
  }
  return null;
}

// L·∫•y phi√™n √¢m cho c·∫£ ƒëo·∫°n vƒÉn
async function getPhoneticForText(text) {
  const words = text
    .trim()
    .split(/\s+/)
    .filter((w) => w.length > 0);

  const isLongText = words.length > 5;

  const phonetics = await Promise.all(
    words.map(async (word) => {
      const cleanWord = word.replace(/[.,!?;:'"()]/g, "");
      if (!cleanWord) return null;

      const phonetic = await getPhoneticForWord(cleanWord);
      return phonetic;
    })
  );

  const ukParts = [];
  const usParts = [];

  phonetics.forEach((p, idx) => {
    if (p) {
      if (!isLongText && p.uk) {
        ukParts.push(p.uk);
      }
      if (p.us) {
        usParts.push(p.us);
      } else if (p.uk) {
        usParts.push(p.uk);
      } else {
        const cleanWord = words[idx].replace(/[.,!?;:'"()]/g, "");
        usParts.push(cleanWord);
      }
    } else {
      const cleanWord = words[idx].replace(/[.,!?;:'"()]/g, "");
      if (!isLongText) ukParts.push(cleanWord);
      usParts.push(cleanWord);
    }
  });

  const formatPhonetics = (parts) => {
    if (parts.length === 0) {
      return null;
    }
    const combined = parts
      .map((part) => (part ? part.replace(/^\/|\/$/g, "") : ""))
      .filter(Boolean)
      .join(" ");

    if (combined) {
      return `//${combined}//`;
    }
    return null;
  };

  return {
    uk: null,
    us: formatPhonetics(usParts),
  };
}

// S·ª≠ d·ª•ng Edge TTS API
async function speakWithEdgeTTS(text) {
  if (!isSoundEnabled) return;

  speechSynthesis.cancel();

  try {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "en-US";
    utterance.rate = 0.9;
    utterance.pitch = 1;

    const voices = speechSynthesis.getVoices();
    const ariaVoice =
      voices.find(
        (voice) => voice.name.includes("Aria") && voice.lang === "en-US"
      ) ||
      voices.find(
        (voice) =>
          voice.name.includes("Natural") && voice.lang.startsWith("en-US")
      ) ||
      voices.find(
        (voice) =>
          (voice.name.includes("Microsoft") || voice.name.includes("Online")) &&
          voice.lang === "en-US"
      ) ||
      voices.find((voice) => voice.lang === "en-US");

    if (ariaVoice) {
      utterance.voice = ariaVoice;
    }

    speechSynthesis.speak(utterance);
  } catch (error) {
    console.error("Error with TTS:", error);
  }
}

// Toggle √¢m thanh
function toggleSound() {
  isSoundEnabled = !isSoundEnabled;

  if (!isSoundEnabled) {
    speechSynthesis.cancel();
  }

  const btn = document.getElementById("sound-toggle");
  if (btn) {
    btn.innerHTML = isSoundEnabled
      ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>'
      : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
    btn.style.opacity = isSoundEnabled ? "1" : "0.5";
  }
}

// Th√™m ch·ª©c nƒÉng drag popup
function enableDragging(header) {
  header.style.cursor = "move";

  header.addEventListener("mousedown", (e) => {
    if (e.target.closest("button")) return;

    isDragging = true;
    const rect = popup.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;

    header.style.cursor = "grabbing";
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;

    e.preventDefault();
    const x = e.clientX - dragOffset.x;
    const y = e.clientY - dragOffset.y;

    popup.style.left = x + "px";
    popup.style.top = y + "px";
  });

  document.addEventListener("mouseup", () => {
    if (isDragging) {
      isDragging = false;
      header.style.cursor = "move";
    }
  });
}

// Hi·ªÉn th·ªã popup
// --- 3. SHOW POPUP (NEW POSITION & UI) ---
// --- 3. SHOW POPUP (OPTIMIZED & SAFE) ---
async function showPopup(rect, text, contextText) {
  if (!popup) popup = createPopup();
  isPopupOpen = true;

  // 1. Hi·ªÉn th·ªã UI Loading ngay l·∫≠p t·ª©c ƒë·ªÉ user bi·∫øt app ƒëang ch·∫°y
  popup.innerHTML =
    '<div class="tts-content"><div class="tts-loading">‚è≥ ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...</div></div>';
  popup.style.display = "block";

  // 2. T√≠nh to√°n v·ªã tr√≠ hi·ªÉn th·ªã (∆Øu ti√™n hi·ªán b√™n tr√™n)
  const popupHeight = 400; // Chi·ªÅu cao ∆∞·ªõc l∆∞·ª£ng
  let topPos = rect.top + window.scrollY - popupHeight - 20;
  let leftPos = rect.left + window.scrollX;

  // N·∫øu b·ªã che ·ªü tr√™n th√¨ l·∫≠t xu·ªëng d∆∞·ªõi
  if (topPos < window.scrollY) topPos = rect.bottom + window.scrollY + 10;
  // N·∫øu b·ªã tr√†n l·ªÅ ph·∫£i th√¨ ƒë·∫©y sang tr√°i
  if (leftPos + 350 > window.innerWidth) leftPos = window.innerWidth - 360;

  popup.style.top = `${topPos}px`;
  popup.style.left = `${leftPos}px`;

  try {
    // A. Ki·ªÉm tra Cache tr∆∞·ªõc
    let data = await getFromCache(text);

    // B. N·∫øu ch∆∞a c√≥ cache, g·ªçi API
    if (!data) {
      // --- LOGIC QUAN TR·ªåNG: CHECK ƒê·ªò D√ÄI ---
      // N·∫øu ch·ªçn qu√° d√†i (> 5 t·ª´), ta coi l√† ƒëo·∫°n vƒÉn.
      // Ch·ªâ d·ªãch, KH√îNG l·∫•y ·∫£nh v√† phi√™n √¢m t·ª´ng t·ª´ ƒë·ªÉ tr√°nh treo m√°y.
      const wordCount = text.trim().split(/\s+/).length;
      const isLongText = wordCount > 5;

      // T·∫°o danh s√°ch c√°c vi·ªác c·∫ßn l√†m (Promises)
      const promises = [getTranslation(text, contextText)];

      if (!isLongText) {
        // N·∫øu t·ª´ ng·∫Øn: L·∫•y th√™m phi√™n √¢m v√† ·∫£nh
        promises.push(getPhoneticForText(text));
        promises.push(getImages(text));
      } else {
        // N·∫øu t·ª´ d√†i: Tr·∫£ v·ªÅ r·ªóng ngay l·∫≠p t·ª©c (kh√¥ng g·ªçi API)
        promises.push(Promise.resolve(null)); // Phi√™n √¢m r·ªóng
        promises.push(Promise.resolve([])); // ·∫¢nh r·ªóng
      }

      // Ch·∫°y song song t·∫•t c·∫£ request
      const [translation, phonetics, images] = await Promise.all(promises);

      data = { translation, phonetics, images, text, contextText };

      // Ch·ªâ l∆∞u cache n·∫øu d·ªãch th√†nh c√¥ng
      if (translation) {
        await saveToCache(text, data);
        await saveToHistory(text, data);
      }
    } else {
      // N·∫øu ƒë√£ c√≥ cache nh∆∞ng ng·ªØ c·∫£nh m·ªõi, update l·∫°i ng·ªØ c·∫£nh
      if (!data.contextMeaning && contextText) {
        const translation = await getTranslation(text, contextText);
        if (translation) data.translation = translation;
      }
    }

    // C. Render UI (N·ªôi dung Popup)
    let content = `
        <div class="tts-header" id="popup-header">
          <button id="sound-toggle" class="sound-btn" title="B·∫≠t/T·∫Øt ti·∫øng">${
            isSoundEnabled ? "üîä" : "üîá"
          }</button>
          <div style="flex:1"></div>
          <button id="close-popup" class="close-btn" title="ƒê√≥ng">‚úï</button>
        </div>
        
        <div class="tts-actions">
            <div style="display:flex; gap:10px; align-items:center;">
                <button id="replay-tts-btn" class="mic-btn" style="width:40px; height:40px; background:#4CAF50;" title="Nghe l·∫°i (TTS)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                </button>
                <button id="mic-btn" class="mic-btn" title="Ki·ªÉm tra ph√°t √¢m (Azure)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                </button>
            </div>
            <div id="assessment-result"></div>
        </div>

        <div class="tts-content">
      `;

    // 1. Hi·ªÉn th·ªã ·∫¢nh (Ch·ªâ hi·ªán n·∫øu c√≥)
    if (data.images && data.images.length) {
      content += `<div class="tts-images-container">
            ${data.images
              .map(
                (url) =>
                  `<div class="tts-image"><img src="${url}" onerror="this.style.display='none'"/></div>`
              )
              .join("")}
        </div>`;
    }

    // 2. Hi·ªÉn th·ªã Phi√™n √¢m (Ch·ªâ hi·ªán n·∫øu c√≥)
    if (data.phonetics && (data.phonetics.us || data.phonetics.uk)) {
      content += `<div class="tts-phonetic">
            ${
              data.phonetics.uk
                ? `<div class="phonetic-item"><span class="flag">üá¨üáß</span><span class="phonetic-text">${data.phonetics.uk}</span></div>`
                : ""
            }
            ${
              data.phonetics.us
                ? `<div class="phonetic-item"><span class="flag">üá∫üá∏</span><span class="phonetic-text">${data.phonetics.us}</span></div>`
                : ""
            }
        </div>`;
    }

    // 3. Hi·ªÉn th·ªã Nghƒ©a (Dictionary Style) & Ng·ªØ c·∫£nh
    if (data.translation) {
      // 3.1. Hi·ªán t·ª´ g·ªëc
      content += `<div class="word-text" style="font-size:24px; text-align:center; margin-bottom:5px;">${data.text}</div>`;

      // 3.2. [NEW] LU√îN HI·ªÜN NGHƒ®A CH√çNH (Google Translate Meaning)
      // L·∫•y nghƒ©a ch√≠nh t·ª´ data
      const mainMeaning =
        typeof data.translation === "string"
          ? data.translation
          : data.translation.wordMeaning;

      if (mainMeaning) {
        content += `<div class="primary-meaning">${mainMeaning}</div>`;
      }

      // 3.3. Hi·ªán T·ª´ ƒëi·ªÉn chi ti·∫øt (N·∫øu c√≥)
      if (data.translation.dict && data.translation.dict.length > 0) {
        content += `<div class="dict-container">`;
        data.translation.dict.forEach((d) => {
          content += `
                    <div class="dict-row">
                        <span class="dict-pos">${d.pos}</span>
                        <span class="dict-meanings">${d.terms.join(", ")}</span>
                    </div>
                `;
        });
        content += `</div>`;
      }
      // (B·ªè ph·∫ßn else c≈© v√¨ m√¨nh ƒë√£ hi·ªán mainMeaning ·ªü tr√™n r·ªìi)

      // 3.4. Hi·ªán Ng·ªØ c·∫£nh (Context)
      if (data.translation.contextMeaning) {
        content += `
                <div class="context-box">
                    <strong>Ng·ªØ c·∫£nh:</strong><br/>
                    <em style="color:#777">"...${
                      data.contextText || ""
                    }..."</em><br/>
                    üëâ <span style="color:#2e7d32; font-weight:600;">${
                      data.translation.contextMeaning
                    }</span>
                </div>
            `;
      }
    } else {
      content += `<div class="tts-info">Kh√¥ng t√¨m th·∫•y b·∫£n d·ªãch.</div>`;
    }

    content += `</div>`; // End tts-content
    popup.innerHTML = content;

    // D. G√°n s·ª± ki·ªán cho c√°c n√∫t b·∫•m
    const header = document.getElementById("popup-header");
    if (typeof enableDragging === "function") enableDragging(header);

    document.getElementById("close-popup").onclick = closePopup;
    document.getElementById("sound-toggle").onclick = toggleSound;
    document.getElementById("replay-tts-btn").onclick = () =>
      speakWithEdgeTTS(text);

    const micBtn = document.getElementById("mic-btn");
    if (micBtn) {
      micBtn.onclick = (e) => {
        e.stopPropagation();
        // ƒê·∫£m b·∫£o h√†m handleMicClick ƒë√£ c√≥ trong code
        if (typeof handleMicClick === "function") handleMicClick(text, micBtn);
      };
    }
  } catch (err) {
    console.error("Popup Render Error:", err);
    // Hi·ªÉn th·ªã l·ªói ra UI thay v√¨ treo "ƒêang t·∫£i"
    popup.innerHTML = `
        <div class="tts-header"><button id="close-error" class="close-btn">‚úï</button></div>
        <div class="tts-content" style="color:#ff5252; text-align:center; padding:20px;">
            ‚ö†Ô∏è L·ªói x·ª≠ l√Ω: ${err.message}<br>
            <span style="font-size:12px; color:#999;">H√£y th·ª≠ reload trang ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.</span>
        </div>`;
    document.getElementById("close-error").onclick = closePopup;
  }
}
// --- 4. FLASHCARD SYSTEM (15 MINS) ---

function showFlashcard(item) {
  // X√≥a c√°i c≈© n·∫øu ƒëang hi·ªán
  const oldCard = document.getElementById("vocab-flashcard");
  if (oldCard) oldCard.remove();

  const card = document.createElement("div");
  card.id = "vocab-flashcard";
  card.className = "flashcard-slide-in"; // Animation class (trong CSS)

  let imgHtml = "";
  if (item.data.images && item.data.images.length > 0) {
    imgHtml = `<img src="${item.data.images[0]}" style="width:100%; height:120px; object-fit:cover; border-radius:8px 8px 0 0; display:block;">`;
  }

  const meaning = item.data.translation.wordMeaning || item.data.translation;

  card.innerHTML = `
        ${imgHtml}
        <div style="padding:15px;">
            <div style="font-size:10px; color:#888; text-transform:uppercase; margin-bottom:5px;">√în t·∫≠p t·ª´ v·ª±ng</div>
            <h3 style="margin:0; font-size:22px; color:#333;">${item.word}</h3>
            <p style="margin:5px 0 10px 0; color:#555; font-size:14px;">${meaning}</p>
            
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="fc-play-btn" style="background:#58cc02; border:none; border-radius:50%; width:32px; height:32px; color:white; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                    ‚ñ∂
                </button>
                <div style="font-size:10px; color:#999;" id="fc-timer">10s</div>
            </div>
        </div>
        <button id="fc-close" style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.5); color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer;">‚úï</button>
    `;

  document.body.appendChild(card);

  // Auto ƒë·ªçc √¢m thanh
  speakWithEdgeTTS(item.word);

  // B·∫Øt s·ª± ki·ªán
  document.getElementById("fc-play-btn").onclick = () =>
    speakWithEdgeTTS(item.word);
  document.getElementById("fc-close").onclick = () => card.remove();

  // ƒê·∫øm ng∆∞·ª£c 10s r·ªìi t·ª± t·∫Øt
  let timeLeft = 10;
  const timerElem = document.getElementById("fc-timer");
  const interval = setInterval(() => {
    timeLeft--;
    timerElem.innerText = `${timeLeft}s`;
    if (timeLeft <= 0) {
      clearInterval(interval);
      card.classList.add("flashcard-slide-out"); // Animation bi·∫øn m·∫•t
      setTimeout(() => card.remove(), 500);
    }
  }, 1000);
}

// L·∫Øng nghe tin nh·∫Øn t·ª´ background.js (M·ªói 15p)
chrome.runtime.onMessage.addListener(async (request, sender, sendResponse) => {
  if (request.action === "SHOW_FLASHCARD") {
    const result = await chrome.storage.local.get(["vocabHistory"]);
    const history = result.vocabHistory || [];

    if (history.length > 0) {
      // L·∫•y ng·∫´u nhi√™n 1 t·ª´ trong 10 t·ª´ g·∫ßn nh·∫•t
      const recentItems = history.slice(0, 10);
      const randomItem =
        recentItems[Math.floor(Math.random() * recentItems.length)];
      showFlashcard(randomItem);
    }
  }
});

// X·ª≠ l√Ω s·ª± ki·ªán nh·∫•n ph√≠m
// --- 5. EVENT INPUT (CAPTURE CONTEXT) ---
// --- 5. EVENT INPUT (SMART CONTEXT CAPTURE) ---
document.addEventListener("keydown", async (e) => {
  if (e.key === "Shift") {
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();

    if (selectedText) {
      const range = selection.getRangeAt(0);
      const rect = range.getBoundingClientRect();

      // --- LOGIC L·∫§Y NG·ªÆ C·∫¢NH TH√îNG MINH (SMART CONTEXT) ---
      let contextText = "";

      try {
        if (selection.anchorNode && selection.anchorNode.parentElement) {
          const parentText = selection.anchorNode.parentElement.innerText;

          // T√¨m v·ªã tr√≠ c·ªßa t·ª´ ƒë∆∞·ª£c ch·ªçn trong ƒëo·∫°n vƒÉn cha
          // L∆∞u √Ω: indexOf c√≥ th·ªÉ t√¨m sai n·∫øu t·ª´ xu·∫•t hi·ªán nhi·ªÅu l·∫ßn,
          // nh∆∞ng ƒë√¢y l√† c√°ch nh·∫π nh·∫•t cho browser extension.
          const startIdx = parentText.indexOf(selectedText);
          const endIdx = startIdx + selectedText.length;

          if (startIdx !== -1) {
            // 1. L·∫•y t·ªëi ƒëa 100 k√Ω t·ª± tr∆∞·ªõc v√† sau t·ª´ ƒë√≥
            const lookBack = 100;
            const lookAhead = 100;

            // X√°c ƒë·ªãnh v√πng c·∫Øt th√¥
            let sliceStart = Math.max(0, startIdx - lookBack);
            let sliceEnd = Math.min(parentText.length, endIdx + lookAhead);

            // 2. Tinh ch·ªânh: C·ªë g·∫Øng t√¨m d·∫•u ch·∫•m c√¢u (.) ƒë·ªÉ c·∫Øt cho ƒë·∫πp
            // T√¨m d·∫•u ch·∫•m g·∫ßn nh·∫•t TR∆Ø·ªöC v√πng c·∫Øt (trong ph·∫°m vi sliceStart)
            const lastDotBefore = parentText.lastIndexOf(".", startIdx);
            if (lastDotBefore !== -1 && lastDotBefore >= sliceStart) {
              sliceStart = lastDotBefore + 1; // L·∫•y sau d·∫•u ch·∫•m
            }

            // T√¨m d·∫•u ch·∫•m g·∫ßn nh·∫•t SAU v√πng c·∫Øt
            const firstDotAfter = parentText.indexOf(".", endIdx);
            if (firstDotAfter !== -1 && firstDotAfter <= sliceEnd) {
              sliceEnd = firstDotAfter + 1; // L·∫•y c·∫£ d·∫•u ch·∫•m
            }

            // C·∫Øt chu·ªói
            contextText = parentText.substring(sliceStart, sliceEnd).trim();

            // Clean up: X√≥a xu·ªëng d√≤ng th·ª´a
            contextText = contextText.replace(/\s+/g, " ");
          }
        }
      } catch (err) {
        console.warn("Context extraction error:", err);
        contextText = ""; // Fallback n·∫øu l·ªói
      }

      // Gi·ªõi h·∫°n c·ª©ng l·∫ßn cu·ªëi ƒë·ªÉ ƒë·∫£m b·∫£o API kh√¥ng bao gi·ªù ch·∫øt
      if (contextText.length > 200) {
        contextText = "..." + contextText.substring(0, 200) + "...";
      }
      // -----------------------------------------------------

      // ƒê·ªçc ngay l·∫≠p t·ª©c
      speakWithEdgeTTS(selectedText);

      // G·ªçi popup
      showPopup(rect, selectedText, contextText);
    } else if (isPopupOpen) {
      closePopup();
    }
  } else if (e.key === "Escape" && isPopupOpen) {
    closePopup();
  }
});

// Kh·ªüi t·∫°o
async function init() {
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = () => {
      const voices = speechSynthesis.getVoices();
      console.log(
        "Available voices:",
        voices.filter((v) => v.lang.startsWith("en-US")).map((v) => v.name)
      );
    };
  }
  createPopup();
}

init();
/* =========================================
   C·∫¨P NH·∫¨T: LOGIC X·ª¨ L√ù L·ªñI (ERROR HANDLING)
   ========================================= */

// 1. X·ª≠ l√Ω khi b·∫•m n√∫t Mic
async function handleMicClick(referenceText, btnElement) {
  if (!isRecording) {
    // B·∫Øt ƒë·∫ßu ghi √¢m
    try {
      // Check xem tr√¨nh duy·ªát c√≥ h·ªó tr·ª£ kh√¥ng
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ ghi √¢m!");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);

      mediaRecorder.onstop = async () => {
        // UI: ƒêang x·ª≠ l√Ω
        const resultDiv = document.getElementById("assessment-result");
        if (resultDiv) {
          resultDiv.innerHTML =
            '<div style="font-size:12px; color:#ddd; text-align:center; padding:5px;">‚è≥ ƒêang g·ª≠i l√™n Azure...<br>(Qu√° tr√¨nh n√†y m·∫•t kho·∫£ng 2-3s)</div>';
        }

        try {
          // Gom chunk th√†nh blob
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

          // [NEW] L∆∞u v√†o bi·∫øn global ƒë·ªÉ replay sau n√†y
          lastRecordedBlob = audioBlob;

          // Debug: Log ra console ƒë·ªÉ check
          console.log("Audio recorded size:", audioBlob.size);

          if (audioBlob.size < 1000) {
            throw new Error("File ghi √¢m qu√° ng·∫Øn ho·∫∑c kh√¥ng c√≥ ti·∫øng.");
          }

          // G·ªçi h√†m x·ª≠ l√Ω ch√≠nh (gi·ªØ nguy√™n logic c≈©)
          // L∆∞u √Ω: truy·ªÅn th√™m referenceText v√†o render ƒë·ªÉ n√∫t Standard ho·∫°t ƒë·ªông
          const result = await assessPronunciation(audioBlob, referenceText);

          // Render k·∫øt qu·∫£ (truy·ªÅn th√™m referenceText)
          renderAssessmentResult(result, resultDiv, referenceText);
        } catch (err) {
          // ... (gi·ªØ nguy√™n code x·ª≠ l√Ω l·ªói c≈©)
          console.error("Processing Error:", err);
          if (resultDiv) {
            resultDiv.innerHTML = `<div style="color:#ff5252; font-size:13px; text-align:center; padding:5px;">‚ùå L·ªói: ${err.message}</div>`;
          }
        } finally {
          // Lu√¥n lu√¥n t·∫Øt stream Mic ƒë·ªÉ gi·∫£i ph√≥ng RAM
          stream.getTracks().forEach((track) => track.stop());
        }
      };

      mediaRecorder.start();
      isRecording = true;
      btnElement.classList.add("recording");
    } catch (err) {
      console.error("Mic Access Error:", err);
      alert("Kh√¥ng th·ªÉ m·ªü Mic. H√£y ki·ªÉm tra quy·ªÅn truy c·∫≠p!");
    }
  } else {
    // Stop recording
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
    isRecording = false;
    btnElement.classList.remove("recording");
  }
}

// 2. G·ªçi API Azure Speech (ƒê√£ b·ªçc Try-Catch to√†n b·ªô)
async function assessPronunciation(audioBlob, referenceText) {
  try {
    const result = await chrome.storage.sync.get(["azureKey", "azureRegion"]);
    const key = result.azureKey;
    const region = result.azureRegion;

    if (!key || !region) {
      throw new Error("Ch∆∞a nh·∫≠p Azure Key/Region trong c√†i ƒë·∫∑t.");
    }

    // Convert WebM sang WAV 16kHz Mono
    // L·ªói th∆∞·ªùng x·∫£y ra ·ªü ƒë√¢y do convert
    const wavBlob = await convertAudioToWav(audioBlob);
    console.log("Converted WAV size:", wavBlob.size);

    const assessParams = {
      ReferenceText: referenceText,
      GradingSystem: "HundredMark",
      Granularity: "Phoneme",
      Dimension: "Comprehensive",
    };

    const paramsHeader = btoa(JSON.stringify(assessParams));
    const url = `https://${region}.stt.speech.microsoft.com/speech/recognition/conversation/cognitiveservices/v1?language=en-US`;

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Ocp-Apim-Subscription-Key": key,
        "Content-Type": "audio/wav; codecs=audio/pcm; samplerate=16000",
        Accept: "application/json",
        "Pronunciation-Assessment": paramsHeader,
      },
      body: wavBlob,
    });

    if (!response.ok) {
      // N·∫øu Azure tr·∫£ l·ªói (400, 401...)
      const errText = await response.text();
      console.error("Azure API Error:", response.status, errText);

      if (response.status === 401)
        throw new Error("Sai Azure Key ho·∫∑c Region.");
      if (response.status === 400)
        throw new Error("Bad Request (Audio l·ªói ho·∫∑c Text qu√° d√†i).");

      throw new Error(
        `Azure Error ${response.status}: ${errText.substring(0, 50)}...`
      );
    }

    return await response.json();
  } catch (e) {
    // N√©m l·ªói ra ngo√†i ƒë·ªÉ handleMicClick b·∫Øt ƒë∆∞·ª£c
    throw e;
  }
}
/* ======================================================
   H√ÄM HI·ªÇN TH·ªä K·∫æT QU·∫¢ CHI TI·∫æT (ELSA STYLE)
   ====================================================== */
// [UPDATE] Th√™m tham s·ªë referenceText v√†o cu·ªëi
function renderAssessmentResult(data, container, referenceText) {
  if (!container) return;

  console.log("üîç Azure Response:", data);

  // 1. Check l·ªói c∆° b·∫£n (Gi·ªØ nguy√™n)
  if (!data || data.error) {
    container.innerHTML = `<div style="color:#ff5252; text-align:center;">‚ö†Ô∏è ${
      data?.error || "L·ªói API"
    }</div>`;
    return;
  }
  if (!data.NBest || !data.NBest[0]) {
    container.innerHTML = `<div style="color:#ffb74d; text-align:center;">ü§î Kh√¥ng nghe r√µ. Th·ª≠ l·∫°i nh√©!</div>`;
    return;
  }

  const result = data.NBest[0];

  // L·∫•y ƒëi·ªÉm t·ªïng (Flattened JSON fix) - Gi·ªØ nguy√™n logic c≈©
  const totalScore =
    result.AccuracyScore !== undefined
      ? result.AccuracyScore
      : result.PronunciationAssessment
      ? result.PronunciationAssessment.AccuracyScore
      : 0;

  const words = result.Words || [];

  // X√°c ƒë·ªãnh m√†u cho v√≤ng tr√≤n ƒëi·ªÉm t·ªïng - Gi·ªØ nguy√™n
  let scoreColor = "#ff5252";
  if (totalScore >= 80) scoreColor = "#4caf50";
  else if (totalScore >= 60) scoreColor = "#ffeb3b";

  // --- B·∫ÆT ƒê·∫¶U RENDER HTML ---
  // Th√™m ID ƒë·ªÉ d·ªÖ querySelector n√∫t b·∫•m
  let html = `<div class="assessment-box" id="result-box-content" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-top:10px;">`;

  // [NEW] 2 N√∫t Playback: User Voice & Azure Standard
  html += `
    <div class="assessment-actions">
        <button id="btn-play-user" class="action-btn-small btn-user-audio" title="Nghe l·∫°i gi·ªçng b·∫°n">
            üó£Ô∏è My Voice
        </button>
        <button id="btn-play-standard" class="action-btn-small btn-ref-audio" title="Nghe gi·ªçng chu·∫©n">
            üéß Standard
        </button>
    </div>
  `;

  // 1. V√≤ng tr√≤n ƒëi·ªÉm s·ªë (Gi·ªØ nguy√™n)
  html += `
    <div class="total-score-circle" style="border-color: ${scoreColor}; color: ${scoreColor}">
      ${Math.round(totalScore)}
    </div>
    <div style="text-align:center; color:#ddd; font-size:13px; margin-bottom:15px;">ƒêi·ªÉm ph√°t √¢m t·ªïng qu√°t</div>
  `;

  // 2. Container ch·ª©a c√°c t·ª´ (Gi·ªØ nguy√™n logic loop words)
  html += `<div class="analyzed-content">`;

  words.forEach((word) => {
    // ... (Gi·ªØ nguy√™n logic render t·ª´ng t·ª´ v√† phoneme c≈© c·ªßa b·∫°n ·ªü ƒë√¢y) ...
    // ƒê·ªÉ ti·∫øt ki·ªám kh√¥ng gian chat, t√¥i vi·∫øt t·∫Øt ƒëo·∫°n n√†y l√† "RENDER_WORDS_LOGIC"
    // B·∫°n h√£y copy paste l·∫°i ƒëo·∫°n logic loop words c≈© v√†o ƒë√¢y nh√©

    const wordText = word.Word;
    const wScore =
      word.AccuracyScore ||
      (word.PronunciationAssessment
        ? word.PronunciationAssessment.AccuracyScore
        : 0);
    const errorType =
      word.ErrorType ||
      (word.PronunciationAssessment
        ? word.PronunciationAssessment.ErrorType
        : "None");
    let wordColor = "#fff";
    if (errorType === "Omission") wordColor = "#777";
    else if (wScore < 60) wordColor = "#ff5252";

    const phonemes = word.Phonemes || [];
    let phonemeHtml = "";

    if (errorType === "Omission") {
      phonemeHtml = `<span style="font-size:10px; color:#999;">(missed)</span>`;
    } else {
      phonemes.forEach((p) => {
        const pScore = p.AccuracyScore;
        const pText = p.Phoneme;
        let pClass = "p-bad";
        if (pScore >= 90) pClass = "p-perfect";
        else if (pScore >= 80) pClass = "p-good";
        else if (pScore >= 60) pClass = "p-fair";
        phonemeHtml += `<span class="phoneme-char ${pClass}" title="√Çm: /${pText}/ - ƒêi·ªÉm: ${pScore}">${pText}</span>`;
      });
    }

    html += `
      <div class="word-block">
        <span class="word-text" style="color:${wordColor}">${wordText}</span>
        <div class="phoneme-row">${phonemeHtml}</div>
      </div>
    `;
  });

  html += `</div>`; // ƒê√≥ng analyzed-content
  html += `</div>`; // ƒê√≥ng assessment-box

  container.innerHTML = html;

  // [NEW] G√°n s·ª± ki·ªán Click cho 2 n√∫t v·ª´a t·∫°o
  // C·∫ßn d√πng setTimeout ho·∫∑c requestAnimationFrame ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ ƒë∆∞·ª£c render
  setTimeout(() => {
    const btnUser = document.getElementById("btn-play-user");
    const btnStandard = document.getElementById("btn-play-standard");

    // Play User Recording
    if (btnUser && lastRecordedBlob) {
      btnUser.onclick = () => {
        const audioUrl = URL.createObjectURL(lastRecordedBlob);
        const audio = new Audio(audioUrl);
        audio.play();
      };
    }

    // Play Standard (D√πng l·∫°i h√†m speakWithEdgeTTS c√≥ s·∫µn)
    if (btnStandard && referenceText) {
      btnStandard.onclick = () => {
        speakWithEdgeTTS(referenceText);
      };
    }
  }, 0);
}
// 1. Chuy·ªÉn ƒë·ªïi Blob Audio sang WAV 16kHz Mono
async function convertAudioToWav(audioBlob) {
  // T·∫°o AudioContext v·ªõi sample rate 16000 (chu·∫©n Azure Speech)
  const audioContext = new (window.AudioContext || window.webkitAudioContext)({
    sampleRate: 16000,
  });
  const arrayBuffer = await audioBlob.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

  // L·∫•y d·ªØ li·ªáu channel 0 (Mono)
  const pcmData = audioBuffer.getChannelData(0);

  // Encode sang WAV
  const wavBuffer = encodeWAV(pcmData, 16000);
  return new Blob([wavBuffer], { type: "audio/wav" });
}

// 2. H√†m Encode c·∫•u tr√∫c file WAV
function encodeWAV(samples, sampleRate) {
  const buffer = new ArrayBuffer(44 + samples.length * 2);
  const view = new DataView(buffer);

  // Helper vi·∫øt chu·ªói
  const writeString = (view, offset, string) => {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  };

  /* RIFF identifier */
  writeString(view, 0, "RIFF");
  /* file length */
  view.setUint32(4, 36 + samples.length * 2, true);
  /* RIFF type */
  writeString(view, 8, "WAVE");
  /* format chunk identifier */
  writeString(view, 12, "fmt ");
  /* format chunk length */
  view.setUint32(16, 16, true);
  /* sample format (raw) */
  view.setUint16(20, 1, true);
  /* channel count (mono) */
  view.setUint16(22, 1, true);
  /* sample rate */
  view.setUint32(24, sampleRate, true);
  /* byte rate (sample rate * block align) */
  view.setUint32(28, sampleRate * 2, true);
  /* block align (channel count * bytes per sample) */
  view.setUint16(32, 2, true);
  /* bits per sample */
  view.setUint16(34, 16, true);
  /* data chunk identifier */
  writeString(view, 36, "data");
  /* data chunk length */
  view.setUint32(40, samples.length * 2, true);

  // Ghi d·ªØ li·ªáu PCM
  floatTo16BitPCM(view, 44, samples);

  return view;
}

// 3. Chuy·ªÉn ƒë·ªïi Float sang 16-bit PCM
function floatTo16BitPCM(output, offset, input) {
  for (let i = 0; i < input.length; i++, offset += 2) {
    let s = Math.max(-1, Math.min(1, input[i]));
    output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
  }
}



================================================
FILE: apps/extension/manifest.json
================================================
{
  "manifest_version": 3,
  "name": "Edge TTS Reader & Vocabulary Coach",
  "version": "1.2",
  "description": "ƒê·ªçc vƒÉn b·∫£n, Check ph√°t √¢m Azure, D·ªãch ng·ªØ c·∫£nh & √în t·∫≠p t·ª´ v·ª±ng",
  "permissions": ["storage", "microphone", "alarms"],
  "background": {
    "service_worker": "background.js"
  },
  "action": {
    "default_popup": "popup.html"
  },
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content.js"],
      "css": ["popup.css"]
    }
  ],
  "host_permissions": [
    "https://translate.google.com/*",
    "https://translate.googleapis.com/*",
    "https://commons.wikimedia.org/*",
    "https://api.duckduckgo.com/*",
    "https://www.googleapis.com/*",
    "https://api.unsplash.com/*",
    "https://*.cognitiveservices.azure.com/*"
  ]
}


================================================
FILE: apps/extension/popup.css
================================================
:root {
  --primary-color: #58cc02; /* Xanh l√° ki·ªÉu Duolingo/Elsa */
  --primary-dark: #46a302;
  --accent-color: #1cb0f6; /* Xanh d∆∞∆°ng */
  --text-primary: #3c3c3c;
  --text-secondary: #777777;
  --bg-color: #ffffff;
  --card-bg: #f7f7f7;
  --danger-color: #ff4b4b;
  --warning-color: #ffc800;
  --shadow-soft: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
  --border-radius: 16px;
}

/* Reset & Base */
* {
  box-sizing: border-box;
}

#tts-popup {
  position: absolute;
  background: var(--bg-color);
  color: var(--text-primary);
  padding: 0;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-soft);
  z-index: 999999;
  min-width: 320px;
  max-width: 400px;
  font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
    sans-serif; /* Font tr√≤n tr·ªãa hi·ªán ƒë·∫°i */
  border: 1px solid rgba(0, 0, 0, 0.08);
  overflow: hidden;
  animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popIn {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

/* --- Header --- */
.tts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: #fff;
  border-bottom: 1px solid #f0f0f0;
  cursor: move;
  user-select: none;
}

.sound-btn,
.close-btn {
  background: transparent;
  border: none;
  color: #bbbbbb;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  padding: 0;
}

.sound-btn:hover {
  background: #f0f8ff;
  color: var(--accent-color);
}

.close-btn:hover {
  background: #fff0f0;
  color: var(--danger-color);
}

/* --- Content Area --- */
.tts-content {
  padding: 0 20px 20px 20px;
  max-height: 500px;
  overflow-y: auto;
}

/* --- Images Grid --- */
.tts-images-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin: 15px 0;
  width: 100%;
}

.tts-image {
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
  aspect-ratio: 1;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s;
}

.tts-image:hover {
  transform: scale(1.05);
}

.tts-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* --- Phonetic & Meaning --- */
.tts-phonetic {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  justify-content: center;
}

.phonetic-item {
  display: flex;
  align-items: center;
  font-size: 14px;
  color: var(--text-secondary);
  background: #f5f5f5;
  padding: 4px 10px;
  border-radius: 20px;
}

.phonetic-item .flag {
  margin-right: 6px;
  font-size: 16px;
}

.phonetic-text {
  font-family: "Lucida Console", monospace;
  font-weight: 600;
  color: var(--text-primary);
}

.tts-meaning {
  font-size: 16px;
  color: var(--text-primary);
  line-height: 1.6;
  text-align: center;
  font-weight: 500;
  margin-bottom: 10px;
}

/* --- Actions (Mic Button) --- */
.tts-actions {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 0 20px 0;
  background: linear-gradient(to bottom, rgba(255, 255, 255, 0), #fff 20%);
}

.mic-btn {
  background: var(--accent-color); /* M√†u xanh ch·ªß ƒë·∫°o */
  border: none;
  box-shadow: 0 4px 0 #118ec7; /* Hi·ªáu ·ª©ng n√∫t b·∫•m 3D */
  color: white;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.1s;
  margin-bottom: 10px;
}

.mic-btn:hover {
  filter: brightness(1.1);
  transform: translateY(-2px);
  box-shadow: 0 6px 0 #118ec7;
}

.mic-btn:active {
  transform: translateY(4px);
  box-shadow: 0 0 0 #118ec7;
}

.mic-btn.recording {
  background: var(--danger-color);
  box-shadow: 0 4px 0 #d63e3e;
  animation: pulse-red 1.5s infinite;
}

@keyframes pulse-red {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 75, 75, 0.4);
  }
  70% {
    box-shadow: 0 0 0 15px rgba(255, 75, 75, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 75, 75, 0);
  }
}

/* --- Assessment Result (ELSA Style) --- */
#assessment-result {
  width: 100%;
}

.assessment-box {
  background: #ffffff;
  padding: 15px;
  text-align: center;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* V√≤ng tr√≤n ƒëi·ªÉm s·ªë */
.total-score-circle {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: 5px solid #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: 800;
  margin: 0 auto 5px auto;
  background: #fff;
  color: var(--text-primary);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}

/* Text Word ch√≠nh */
.word-text {
  font-size: 32px;
  font-weight: 800;
  margin: 10px 0 5px 0;
  color: #2b3b4e; /* M√†u xanh ƒë·∫≠m sang tr·ªçng */
  letter-spacing: -0.5px;
}

/* Container Phonemes */
.analyzed-content {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 5px;
}

.word-block {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.phoneme-row {
  display: flex;
  gap: 4px;
  padding: 4px;
  border-radius: 12px;
  background: transparent;
}

.phoneme-char {
  font-family: "Roboto Mono", monospace;
  font-size: 16px;
  font-weight: 600;
  padding: 6px 10px;
  border-radius: 8px;
  transition: all 0.2s;
  min-width: 32px;
  text-align: center;
}

/* M√†u s·∫Øc ƒëi·ªÉm s·ªë (Color Grading) */
/* Xanh (Excellent) */
.p-perfect {
  background-color: #dff6dd;
  color: #2e7d32;
  border: 1px solid #c8e6c9;
}

/* Xanh nh·∫°t (Good) */
.p-good {
  background-color: #f1f8e9;
  color: #558b2f;
  border: 1px solid #dcedc8;
}

/* V√†ng (Fair) */
.p-fair {
  background-color: #fff8e1;
  color: #fbc02d;
  border: 1px solid #ffecb3;
}

/* ƒê·ªè (Bad) */
.p-bad {
  background-color: #ffebee;
  color: #c62828;
  border: 1px solid #ffcdd2;
  position: relative;
}

/* Loading & Info */
.tts-loading,
.tts-info {
  font-size: 14px;
  color: #999;
  text-align: center;
  padding: 10px;
}
/* --- Flashcard Passive Learning --- */
#vocab-flashcard {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 280px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  z-index: 2147483647; /* Max z-index */
  font-family: "Nunito", sans-serif;
  border: 1px solid rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.flashcard-slide-in {
  animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.flashcard-slide-out {
  animation: slideOutRight 0.5s forwards;
}

@keyframes slideInRight {
  from {
    transform: translateX(120%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(120%);
    opacity: 0;
  }
}

/* Style cho Context Box trong Popup ch√≠nh */
.context-box {
  margin-top: 10px;
  padding: 10px;
  background: #f8f9fa;
  border-left: 3px solid var(--accent-color);
  border-radius: 4px;
  font-size: 13px;
  color: var(--text-secondary);
  text-align: left;
  line-height: 1.4;
}
/* --- Dictionary Styles --- */
.dict-container {
  text-align: left;
  margin: 10px 0;
  padding: 0 10px;
}

.dict-row {
  margin-bottom: 8px;
  line-height: 1.5;
  display: flex;
  align-items: baseline;
}

.dict-pos {
  font-size: 11px;
  text-transform: uppercase;
  color: #888;
  background: #eee;
  padding: 2px 6px;
  border-radius: 4px;
  margin-right: 8px;
  font-weight: 700;
  min-width: 45px;
  text-align: center;
}

.dict-meanings {
  font-size: 15px;
  color: #333;
  font-weight: 500;
}
/* --- New: Primary Meaning Style --- */
.primary-meaning {
  font-size: 18px; /* To h∆°n text th∆∞·ªùng */
  color: var(--primary-dark); /* M√†u xanh ƒë·∫≠m cho d·ªÖ nh√¨n */
  font-weight: 700;
  text-align: center;
  margin: 5px 0 10px 0;
  padding-bottom: 8px;
  border-bottom: 1px dashed #eee; /* G·∫°ch ch√¢n nh·∫π ngƒÉn c√°ch v·ªõi dict */
  line-height: 1.4;
}
/* --- Assessment Action Buttons --- */
.assessment-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
}

.action-btn-small {
  border: none;
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.btn-user-audio {
  background: #ffffff;
  color: #d32f2f; /* M√†u ƒë·ªè ghi √¢m */
}
.btn-user-audio:hover {
  background: #ffebee;
}

.btn-ref-audio {
  background: #ffffff;
  color: #1976d2; /* M√†u xanh Azure */
}
.btn-ref-audio:hover {
  background: #e3f2fd;
}



================================================
FILE: apps/extension/popup.html
================================================
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edge TTS Reader - C√†i ƒë·∫∑t</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        width: 450px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .container {
        padding: 20px;
      }

      h2 {
        font-size: 20px;
        margin-bottom: 20px;
        font-weight: 600;
      }

      .guide-section {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 13px;
        line-height: 1.6;
        backdrop-filter: blur(10px);
      }

      .guide-section h3 {
        font-size: 14px;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .guide-section ol {
        padding-left: 20px;
      }

      .guide-section li {
        margin-bottom: 6px;
      }

      .guide-section a {
        color: #fff;
        text-decoration: underline;
      }

      .guide-section a:hover {
        opacity: 0.8;
      }

      .input-group {
        margin-bottom: 15px;
        position: relative;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-group input {
        flex: 1;
        padding: 10px 40px 10px 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        font-size: 14px;
        font-family: monospace;
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        transition: all 0.2s;
      }

      .input-group input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.8);
        background: white;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
      }

      .toggle-visibility {
        position: absolute;
        right: 8px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        padding: 6px;
        z-index: 10;
        opacity: 0.6;
        transition: opacity 0.2s;
      }

      .toggle-visibility:hover {
        opacity: 1;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .save-btn {
        background: white;
        color: #667eea;
      }

      .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .test-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .test-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .status-message {
        margin-top: 15px;
        padding: 12px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        display: none;
      }

      .status-message.show {
        display: block;
      }

      .status-message.success {
        background: rgba(76, 175, 80, 0.9);
        color: white;
      }

      .status-message.error {
        background: rgba(244, 67, 54, 0.9);
        color: white;
      }

      .status-message.warning {
        background: rgba(255, 152, 0, 0.9);
        color: white;
      }

      .status-message.loading {
        background: rgba(33, 150, 243, 0.9);
        color: white;
      }

      .info-note {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 6px;
        font-size: 12px;
        margin-top: 15px;
        border-left: 3px solid rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>‚öôÔ∏è C√†i ƒë·∫∑t Google Search API</h2>

      <div class="guide-section">
        <h3>üìå H∆∞·ªõng d·∫´n l·∫•y API Key:</h3>
        <ol>
          <li>
            Truy c·∫≠p
            <a href="https://console.cloud.google.com/" target="_blank"
              >Google Cloud Console</a
            >
          </li>
          <li>T·∫°o d·ª± √°n m·ªõi ho·∫∑c ch·ªçn d·ª± √°n hi·ªán c√≥</li>
          <li>B·∫≠t Custom Search API</li>
          <li>T·∫°o API Key t·ª´ ph·∫ßn "Credentials"</li>
          <li>D√°n API Key v√†o √¥ d∆∞·ªõi</li>
        </ol>
      </div>

      <div class="guide-section">
        <h3>üìå H∆∞·ªõng d·∫´n l·∫•y Search Engine ID:</h3>
        <ol>
          <li>
            Truy c·∫≠p
            <a
              href="https://programmablesearchengine.google.com/"
              target="_blank"
              >Google Programmable Search Engine</a
            >
          </li>
          <li>T·∫°o search engine m·ªõi</li>
          <li>Sao ch√©p Search Engine ID (cx)</li>
          <li>D√°n v√†o √¥ d∆∞·ªõi</li>
        </ol>
      </div>

      <div class="input-group">
        <label>üîë Main Google API Key:</label>
        <div class="input-wrapper">
          <input
            type="password"
            id="api-key-0"
            class="api-key-input"
            placeholder="Key ch√≠nh (b·∫Øt bu·ªôc)"
          />
          <button type="button" class="toggle-visibility">üëÅÔ∏è</button>
        </div>
      </div>

      <div class="input-group">
        <label>üîç Main Search Engine ID (cx):</label>
        <div class="input-wrapper">
          <input
            type="text"
            id="cx-0"
            class="cx-input"
            placeholder="CX ch√≠nh (b·∫Øt bu·ªôc)"
          />
        </div>
      </div>

      <details
        style="
          margin-bottom: 15px;
          background: rgba(0, 0, 0, 0.1);
          border-radius: 6px;
          padding: 10px;
        "
      >
        <summary style="cursor: pointer; font-weight: 600; font-size: 13px">
          ‚ûï M·ªü r·ªông: 4 Backup Keys (D·ª± ph√≤ng)
        </summary>

        <div
          style="
            margin-top: 10px;
            padding-left: 10px;
            border-left: 2px solid rgba(255, 255, 255, 0.3);
          "
        >
          <label
            style="
              font-size: 12px;
              margin-top: 10px;
              display: block;
              color: #ddd;
            "
            >Backup Set #1:</label
          >
          <div class="input-wrapper" style="margin-bottom: 5px">
            <input
              type="password"
              id="api-key-1"
              class="api-key-input"
              placeholder="API Key d·ª± ph√≤ng 1"
            />
          </div>
          <div class="input-wrapper">
            <input
              type="text"
              id="cx-1"
              class="cx-input"
              placeholder="CX ID d·ª± ph√≤ng 1"
            />
          </div>

          <label
            style="
              font-size: 12px;
              margin-top: 10px;
              display: block;
              color: #ddd;
            "
            >Backup Set #2:</label
          >
          <div class="input-wrapper" style="margin-bottom: 5px">
            <input
              type="password"
              id="api-key-2"
              class="api-key-input"
              placeholder="API Key d·ª± ph√≤ng 2"
            />
          </div>
          <div class="input-wrapper">
            <input
              type="text"
              id="cx-2"
              class="cx-input"
              placeholder="CX ID d·ª± ph√≤ng 2"
            />
          </div>

          <label
            style="
              font-size: 12px;
              margin-top: 10px;
              display: block;
              color: #ddd;
            "
            >Backup Set #3:</label
          >
          <div class="input-wrapper" style="margin-bottom: 5px">
            <input
              type="password"
              id="api-key-3"
              class="api-key-input"
              placeholder="API Key d·ª± ph√≤ng 3"
            />
          </div>
          <div class="input-wrapper">
            <input
              type="text"
              id="cx-3"
              class="cx-input"
              placeholder="CX ID d·ª± ph√≤ng 3"
            />
          </div>

          <label
            style="
              font-size: 12px;
              margin-top: 10px;
              display: block;
              color: #ddd;
            "
            >Backup Set #4:</label
          >
          <div class="input-wrapper" style="margin-bottom: 5px">
            <input
              type="password"
              id="api-key-4"
              class="api-key-input"
              placeholder="API Key d·ª± ph√≤ng 4"
            />
          </div>
          <div class="input-wrapper">
            <input
              type="text"
              id="cx-4"
              class="cx-input"
              placeholder="CX ID d·ª± ph√≤ng 4"
            />
          </div>
        </div>
      </details>

      <div class="input-group">
        <label for="search-engine-input">Search Engine ID (cx):</label>
        <div class="input-wrapper">
          <input
            type="text"
            id="search-engine-input"
            placeholder="Nh·∫≠p Search Engine ID"
          />
        </div>
      </div>

      <div class="button-group">
        <button class="save-btn" id="save-btn">üíæ L∆∞u</button>
        <button class="test-btn" id="test-btn">üß™ Ki·ªÉm tra</button>
      </div>
      <div
        class="guide-section"
        style="
          margin-top: 20px;
          border-top: 1px solid rgba(255, 255, 255, 0.2);
          padding-top: 15px;
        "
      >
        <h3>üéôÔ∏è C√†i ƒë·∫∑t Azure Speech (Pronunciation):</h3>
        <ol>
          <li>
            T·∫°o resource <strong>Speech Services</strong> tr√™n Azure Portal
          </li>
          <li>L·∫•y Key v√† Region (v√≠ d·ª•: eastus, southeastasia)</li>
        </ol>
      </div>

      <div class="input-group">
        <label for="azure-key-input">Azure Speech Key:</label>
        <div class="input-wrapper">
          <input
            type="password"
            id="azure-key-input"
            placeholder="Nh·∫≠p Azure Subscription Key"
          />
        </div>
      </div>

      <div class="input-group">
        <label for="azure-region-input">Azure Region:</label>
        <div class="input-wrapper">
          <input
            type="text"
            id="azure-region-input"
            placeholder="V√≠ d·ª•: eastus"
          />
        </div>
      </div>
      <div class="status-message" id="status-message"></div>

      <div class="info-note">
        üí° <strong>L∆∞u √Ω:</strong> N·∫øu kh√¥ng c·∫•u h√¨nh Google API, extension s·∫Ω
        t·ª± ƒë·ªông s·ª≠ d·ª•ng Unsplash ƒë·ªÉ l·∫•y h√¨nh ·∫£nh.
      </div>
    </div>

    <script src="popup.js"></script>
  </body>
</html>



================================================
FILE: apps/extension/popup.js
================================================
document.addEventListener("DOMContentLoaded", async () => {
  // Elements cho Azure (Gi·ªØ nguy√™n)
  const azureKeyInput = document.getElementById("azure-key-input");
  const azureRegionInput = document.getElementById("azure-region-input");
  const saveBtn = document.getElementById("save-btn");
  const testBtn = document.getElementById("test-btn");

  // X·ª≠ l√Ω n√∫t m·∫Øt th·∫ßn (Toggle Visibility) cho t·∫•t c·∫£ input password
  document.querySelectorAll(".toggle-visibility").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      // T√¨m input c√πng c·∫•p v·ªõi n√∫t b·∫•m
      const input = e.target.parentElement.querySelector("input");
      if (input) {
        input.type = input.type === "password" ? "text" : "password";
      }
    });
  });

  // --- 1. LOAD DATA ---
  chrome.storage.sync.get(
    ["googleApiKeys", "azureKey", "azureRegion"], // L∆∞u √Ω: key m·ªõi l√† 'googleApiKeys' (d·∫°ng m·∫£ng)
    (result) => {
      // Load Azure
      if (result.azureKey) azureKeyInput.value = result.azureKey;
      if (result.azureRegion) azureRegionInput.value = result.azureRegion;

      // Load Google Keys (List)
      const keys = result.googleApiKeys || [];

      // Loop qua 5 slot ƒë·ªÉ ƒëi·ªÅn d·ªØ li·ªáu
      for (let i = 0; i < 5; i++) {
        const keyInput = document.getElementById(`api-key-${i}`);
        const cxInput = document.getElementById(`cx-${i}`);

        if (keys[i]) {
          if (keyInput) keyInput.value = keys[i].key || "";
          if (cxInput) cxInput.value = keys[i].cx || "";
        }
      }
    }
  );

  // --- 2. SAVE DATA ---
  saveBtn.addEventListener("click", () => {
    const azureKey = azureKeyInput.value.trim();
    const azureRegion = azureRegionInput.value.trim();

    // Gom d·ªØ li·ªáu t·ª´ 5 slot Google
    let googleKeysList = [];
    for (let i = 0; i < 5; i++) {
      const keyVal = document.getElementById(`api-key-${i}`).value.trim();
      const cxVal = document.getElementById(`cx-${i}`).value.trim();

      // Ch·ªâ l∆∞u n·∫øu c√≥ ƒëi·ªÅn Key (CX c√≥ th·ªÉ d√πng chung ho·∫∑c ri√™ng)
      if (keyVal) {
        googleKeysList.push({
          key: keyVal,
          cx: cxVal, // N·∫øu cx tr·ªëng, logic b√™n content.js s·∫Ω handle sau
        });
      }
    }

    // Validation
    if (googleKeysList.length === 0) {
      showStatusMessage("‚ö†Ô∏è C·∫ßn √≠t nh·∫•t 1 Google API Key ch√≠nh!", "warning");
      return;
    }

    // Save to Storage
    chrome.storage.sync.set(
      {
        googleApiKeys: googleKeysList, // L∆∞u d·∫°ng m·∫£ng object
        azureKey: azureKey,
        azureRegion: azureRegion,
      },
      () => {
        showStatusMessage(
          `‚úÖ ƒê√£ l∆∞u ${googleKeysList.length} b·ªô key!`,
          "success"
        );
        setTimeout(hideStatusMessage, 3000);
      }
    );
  });

  // --- 3. TEST API (Test key ƒë·∫ßu ti√™n) ---
  testBtn.addEventListener("click", async () => {
    const key0 = document.getElementById("api-key-0").value.trim();
    const cx0 = document.getElementById("cx-0").value.trim();

    if (!key0 || !cx0) {
      showStatusMessage("‚ö†Ô∏è C·∫ßn nh·∫≠p Key & CX ·ªü √¥ ƒë·∫ßu ti√™n ƒë·ªÉ test", "warning");
      return;
    }

    showStatusMessage("‚è≥ ƒêang test Key ch√≠nh...", "loading");

    try {
      const url = `https://www.googleapis.com/customsearch/v1?q=test&cx=${cx0}&searchType=image&key=${key0}&num=1`;
      const response = await fetch(url);

      if (response.ok) {
        showStatusMessage("‚úÖ Key ch√≠nh ho·∫°t ƒë·ªông ngon l√†nh!", "success");
        setTimeout(hideStatusMessage, 3000);
      } else {
        const errorData = await response.json();
        showStatusMessage(
          `‚ùå L·ªói: ${errorData.error?.message || "Check l·∫°i Key/CX"}`,
          "error"
        );
      }
    } catch (error) {
      showStatusMessage(`‚ùå L·ªói m·∫°ng: ${error.message}`, "error");
    }
  });
});

function showStatusMessage(message, type) {
  const statusDiv = document.getElementById("status-message");
  statusDiv.textContent = message;
  statusDiv.className = `status-message show ${type}`;
}

function hideStatusMessage() {
  const statusDiv = document.getElementById("status-message");
  statusDiv.className = "status-message";
}
// Function x·ª≠ l√Ω khi click n√∫t "Star Word"
async function handleStarWord(wordToSave) {
  try {
    // 1. Get Auth Token (Token l∆∞u ·ªü storage khi user login extension)
    const { token } = await chrome.storage.local.get(["token"]);
    if (!token) {
      alert("Please login via Extension first!");
      return;
    }

    // 2. Auto-fetch Missing Info (V√¨ DB c·∫ßn full info)
    // V√≠ d·ª•: G·ªçi Google Translate API free endpoint ƒë·ªÉ l·∫•y nghƒ©a
    const googleData = await fetch(
      `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=vi&dt=t&q=${encodeURI(
        wordToSave
      )}`
    ).then((res) => res.json());

    const meaning = googleData[0][0][0]; // Extract meaning

    // V√≠ d·ª•: G·ªçi Free Dictionary API ƒë·ªÉ l·∫•y phonetics & example
    const dictData = await fetch(
      `https://api.dictionaryapi.dev/api/v2/entries/en/${wordToSave}`
    ).then((res) => res.json());

    const pronunciation = dictData[0]?.phonetics[0]?.text || "";
    const example = dictData[0]?.meanings[0]?.definitions[0]?.example || "";
    const partOfSpeech = dictData[0]?.meanings[0]?.partOfSpeech || "noun";

    // 3. Prepare Payload
    const payload = {
      word: wordToSave,
      meaning: meaning,
      pronunciation: pronunciation,
      example: example,
      partOfSpeech: partOfSpeech,
      topic: "From Extension", // Auto tag source
      isStarred: true,
    };

    // 4. Send to YOUR Backend
    const response = await fetch("http://localhost:5000/vocabulary", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify(payload),
    });

    if (response.ok) {
      updateUI_StarActive(); // ƒê·ªïi m√†u ng√¥i sao tr√™n popup
    }
  } catch (err) {
    console.error("Failed to save word:", err);
  }
}



================================================
FILE: apps/frontend/README.md
================================================
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.



================================================
FILE: apps/frontend/eslint.config.mjs
================================================
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;



================================================
FILE: apps/frontend/next.config.ts
================================================
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactCompiler: true,
};

export default nextConfig;



================================================
FILE: apps/frontend/package.json
================================================
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "next": "16.0.8",
    "react": "19.2.1",
    "react-dom": "19.2.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.17",
    "@tailwindcss/vite": "^4.0.0",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.22",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.0.8",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.0.0",
    "typescript": "^5"
  }
}



================================================
FILE: apps/frontend/postcss.config.js
================================================
module.exports = {
  plugins: {
    '@tailwindcss/postcss': {},
  },
}


================================================
FILE: apps/frontend/postcss.config.mjs
================================================
/** @type {import('postcss-load-config').Config} */
const config = {
  plugins: {
    "@tailwindcss/postcss": {}, // üëà ƒê·ªïi d√≤ng n√†y
    autoprefixer: {},
  },
};

export default config;



================================================
FILE: apps/frontend/tailwind.config.ts
================================================
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}


================================================
FILE: apps/frontend/tsconfig.json
================================================
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}



================================================
FILE: apps/frontend/app/globals.css
================================================
@import "tailwindcss";



================================================
FILE: apps/frontend/app/layout.tsx
================================================
import type { Metadata } from "next";
import './globals.css'
import { AuthProvider } from "../contexts/AuthContext";

export const metadata: Metadata = {
  title: "Vocabulary App",
  description: "Learn English vocabulary",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        <AuthProvider>
          {children}
        </AuthProvider>
      </body>
    </html>
  );
}


================================================
FILE: apps/frontend/app/page.module.css
================================================
.page {
  --background: #fafafa;
  --foreground: #fff;

  --text-primary: #000;
  --text-secondary: #666;

  --button-primary-hover: #383838;
  --button-secondary-hover: #f2f2f2;
  --button-secondary-border: #ebebeb;

  display: flex;
  min-height: 100vh;
  align-items: center;
  justify-content: center;
  font-family: var(--font-geist-sans);
  background-color: var(--background);
}

.main {
  display: flex;
  min-height: 100vh;
  width: 100%;
  max-width: 800px;
  flex-direction: column;
  align-items: flex-start;
  justify-content: space-between;
  background-color: var(--foreground);
  padding: 120px 60px;
}

.intro {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  text-align: left;
  gap: 24px;
}

.intro h1 {
  max-width: 320px;
  font-size: 40px;
  font-weight: 600;
  line-height: 48px;
  letter-spacing: -2.4px;
  text-wrap: balance;
  color: var(--text-primary);
}

.intro p {
  max-width: 440px;
  font-size: 18px;
  line-height: 32px;
  text-wrap: balance;
  color: var(--text-secondary);
}

.intro a {
  font-weight: 500;
  color: var(--text-primary);
}

.ctas {
  display: flex;
  flex-direction: row;
  width: 100%;
  max-width: 440px;
  gap: 16px;
  font-size: 14px;
}

.ctas a {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 40px;
  padding: 0 16px;
  border-radius: 128px;
  border: 1px solid transparent;
  transition: 0.2s;
  cursor: pointer;
  width: fit-content;
  font-weight: 500;
}

a.primary {
  background: var(--text-primary);
  color: var(--background);
  gap: 8px;
}

a.secondary {
  border-color: var(--button-secondary-border);
}

/* Enable hover only on non-touch devices */
@media (hover: hover) and (pointer: fine) {
  a.primary:hover {
    background: var(--button-primary-hover);
    border-color: transparent;
  }

  a.secondary:hover {
    background: var(--button-secondary-hover);
    border-color: transparent;
  }
}

@media (max-width: 600px) {
  .main {
    padding: 48px 24px;
  }

  .intro {
    gap: 16px;
  }

  .intro h1 {
    font-size: 32px;
    line-height: 40px;
    letter-spacing: -1.92px;
  }
}

@media (prefers-color-scheme: dark) {
  .logo {
    filter: invert();
  }

  .page {
    --background: #000;
    --foreground: #000;

    --text-primary: #ededed;
    --text-secondary: #999;

    --button-primary-hover: #ccc;
    --button-secondary-hover: #1a1a1a;
    --button-secondary-border: #1a1a1a;
  }
}



================================================
FILE: apps/frontend/app/page.tsx
================================================
import Image from "next/image";
import styles from "./page.module.css";

export default function Home() {
  return (
    <div className={styles.page}>
      <main className={styles.main}>
        <Image
          className={styles.logo}
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className={styles.intro}>
          <h1>To get started, edit the page.tsx file.</h1>
          <p>
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              target="_blank"
              rel="noopener noreferrer"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              target="_blank"
              rel="noopener noreferrer"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className={styles.ctas}>
          <a
            className={styles.primary}
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className={styles.logo}
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className={styles.secondary}
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}



================================================
FILE: apps/frontend/app/admin/users/page.tsx
================================================
[Empty file]


================================================
FILE: apps/frontend/app/app/auth/callback/page.tsx
================================================
'use client';

import { useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';

export default function GoogleCallbackPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  useEffect(() => {
    const token = searchParams.get('token');

    if (token) {
      // Save token
      localStorage.setItem('token', token);
      
      // Redirect to vocabulary page
      router.push('/vocabulary');
    } else {
      // If no token, redirect to login
      router.push('/login');
    }
  }, [searchParams, router]);

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p>Processing login...</p>
      </div>
    </div>
  );
}


================================================
FILE: apps/frontend/app/login/page.tsx
================================================
'use client';

import { useState } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const { login } = useAuth();
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);

    try {
      await login(email, password);
      router.push('/vocabulary');
    } catch (err: any) {
      setError(err.response?.data?.message || 'Login failed');
    } finally {
      setIsLoading(false);
    }
  };

  const handleGoogleLogin = () => {
    // Redirect to backend Google OAuth
    window.location.href = 'http://localhost:5000/auth/google';
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
        <h1 className="text-3xl font-bold text-center mb-8">üîê Login</h1>

        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="your@email.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 disabled:bg-gray-400"
          >
            {isLoading ? 'Loading...' : 'Login'}
          </button>
        </form>

        <div className="mt-6">
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300"></div>
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
          </div>

          <button
            onClick={handleGoogleLogin}
            className="mt-4 w-full flex items-center justify-center gap-2 border border-gray-300 bg-white py-2 rounded hover:bg-gray-50"
          >
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path
                fill="#4285F4"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
            Continue with Google
          </button>
        </div>

        <p className="mt-6 text-center text-sm text-gray-600">
          Don't have an account?{' '}
          <Link href="/register" className="text-blue-500 hover:underline">
            Register
          </Link>
        </p>
      </div>
    </div>
  );
}


================================================
FILE: apps/frontend/app/register/page.tsx
================================================
'use client';

import { useState } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useRouter } from 'next/navigation';
import Link from 'next/link';

export default function RegisterPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const { register } = useAuth();
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);

    try {
      await register(email, password, name);
      router.push('/vocabulary');
    } catch (err: any) {
      setError(err.response?.data?.message || 'Registration failed');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
        <h1 className="text-3xl font-bold text-center mb-8">üìù Register</h1>

        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Name</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Your name"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="your@email.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 disabled:bg-gray-400"
          >
            {isLoading ? 'Loading...' : 'Register'}
          </button>
        </form>

        <p className="mt-6 text-center text-sm text-gray-600">
          Already have an account?{' '}
          <Link href="/login" className="text-blue-500 hover:underline">
            Login
          </Link>
        </p>
      </div>
    </div>
  );
}


================================================
FILE: apps/frontend/app/vocabulary/page.tsx
================================================
'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import axios from 'axios';

// --- INTERFACES ---
interface VocabItem {
  id: string;
  word: string;
  topic?: string | null;
  partOfSpeech?: string | null;
  pronunciation?: string | null;
  meaning?: string | null;
  example?: string | null;
  relatedWords?: string | null;
  occurrence: number;
  isStarred: boolean;
  createdAt: string;
}

interface FilterState {
  word: string;
  topic: string;
  partOfSpeech: string;
  meaning: string;
}

interface SortState {
  key: string;
  direction: 'asc' | 'desc';
}

export default function VocabularyPage() {
  const { token } = useAuth();

  // --- STATES ---
  const [vocabs, setVocabs] = useState<VocabItem[]>([]);
  const [loading, setLoading] = useState(false);
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [showStarredOnly, setShowStarredOnly] = useState(false);

  const [filters, setFilters] = useState<FilterState>({
    word: '', topic: '', partOfSpeech: '', meaning: ''
  });

  const [sortConfig, setSortConfig] = useState<SortState>({
    key: 'createdAt',
    direction: 'desc'
  });

  // --- QUICK SEARCH STATES ---
  const [showSearch, setShowSearch] = useState(false);
  const [quickSearchText, setQuickSearchText] = useState('');
  const [quickSearchResults, setQuickSearchResults] = useState<VocabItem[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const searchInputRef = useRef<HTMLInputElement>(null);
  const quickSearchDebounce = useRef<NodeJS.Timeout | null>(null);

  const [selectedVocab, setSelectedVocab] = useState<VocabItem | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [isUploading, setIsUploading] = useState(false);
  const debounceRef = useRef<NodeJS.Timeout | null>(null);

  // --- FETCH DATA ---
  const fetchVocabs = useCallback(async (
    pageNum = 1,
    currentFilters = filters,
    currentSort = sortConfig,
    starred = showStarredOnly
  ) => {
    if (!token) return;
    setLoading(true);
    try {
      const params: any = {
        page: pageNum,
        limit: 20,
        ...currentFilters,
        sortBy: currentSort.key,
        sortOrder: currentSort.direction
      };

      if (starred) {
        params.isStarred = 'true';
      }

      const res = await axios.get('http://localhost:5000/vocabulary', {
        headers: { Authorization: `Bearer ${token}` },
        params: params,
      });

      setVocabs(res.data.data);
      setTotalPages(res.data.meta.lastPage);
      setPage(res.data.meta.page);
    } catch (error) {
      console.error("Fetch error:", error);
    } finally {
      setLoading(false);
    }
  }, [token, filters, sortConfig, showStarredOnly]);

  useEffect(() => {
    fetchVocabs();
  }, [fetchVocabs]);

  // --- HANDLERS ---
  const handleToggleStar = async (id: string, currentStatus: boolean, e?: React.MouseEvent) => {
    if (e) e.stopPropagation();

    // Optimistic Update
    const toggleFunc = (list: VocabItem[]) =>
      list.map(item => item.id === id ? { ...item, isStarred: !currentStatus } : item);

    setVocabs(toggleFunc);
    setQuickSearchResults(toggleFunc);
    if (selectedVocab && selectedVocab.id === id) {
      setSelectedVocab({ ...selectedVocab, isStarred: !currentStatus });
    }

    try {
      await axios.patch(`http://localhost:5000/vocabulary/${id}`,
        { isStarred: !currentStatus },
        { headers: { Authorization: `Bearer ${token}` } }
      );
    } catch (error) {
      console.error("Failed to star", error);
      alert("Failed to update star");
    }
  };

  const performQuickSearch = async (text: string) => {
    if (!token || !text.trim()) {
      setQuickSearchResults([]);
      return;
    }
    setIsSearching(true);
    try {
      const res = await axios.get('http://localhost:5000/vocabulary', {
        headers: { Authorization: `Bearer ${token}` },
        params: {
          page: 1, limit: 5, search: text, sortBy: 'word', sortOrder: 'asc'
        }
      });
      setQuickSearchResults(res.data.data);
    } catch (error) {
      console.error("Quick search error", error);
    } finally {
      setIsSearching(false);
    }
  };

  const handleQuickSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const text = e.target.value;
    setQuickSearchText(text);

    if (quickSearchDebounce.current) clearTimeout(quickSearchDebounce.current);
    quickSearchDebounce.current = setTimeout(() => {
      performQuickSearch(text);
    }, 300);
  };

  const handleQuickCreate = async () => {
    if (!quickSearchText || !token) return;
    try {
      const res = await axios.post('http://localhost:5000/vocabulary',
        { word: quickSearchText, isStarred: true },
        { headers: { Authorization: `Bearer ${token}` } }
      );
      alert(`Created "${quickSearchText}"`);
      setShowSearch(false);
      setQuickSearchText('');
      fetchVocabs(1);
      setSelectedVocab(res.data);
    } catch (e) { alert("Error creating word"); }
  };

  useEffect(() => {
    let lastKeyPressTime = 0;
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.target as HTMLElement).tagName === 'INPUT' && !showSearch) return;

      if (e.code === 'Space') {
        const currentTime = new Date().getTime();
        if (currentTime - lastKeyPressTime < 300) {
          e.preventDefault();
          setShowSearch(true);
          setQuickSearchText('');
          setQuickSearchResults([]);
          setTimeout(() => searchInputRef.current?.focus(), 100);
        }
        lastKeyPressTime = currentTime;
      }
      if (e.code === 'Escape') {
        setShowSearch(false);
        setSelectedVocab(null);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [showSearch]);

  const handleSort = (key: string) => {
    let direction: 'asc' | 'desc' = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
    const newSort: SortState = { key, direction };
    setSortConfig(newSort);
    fetchVocabs(1, filters, newSort);
  };

  const getSortIcon = (colKey: string) => {
    if (sortConfig.key !== colKey) return <span className="text-gray-300 ml-1">‚Üï</span>;
    return sortConfig.direction === 'asc' ? <span className="ml-1 text-indigo-600">‚ñ≤</span> : <span className="ml-1 text-indigo-600">‚ñº</span>;
  };

  const handleFilterChange = (field: keyof FilterState, value: string) => {
    const newFilters = { ...filters, [field]: value };
    setFilters(newFilters);
    if (debounceRef.current) clearTimeout(debounceRef.current);
    debounceRef.current = setTimeout(() => fetchVocabs(1, newFilters, sortConfig), 500);
  };

  const handleDelete = async (id: string) => {
    if (!confirm("Delete this word?")) return;
    try {
      await axios.delete(`http://localhost:5000/vocabulary/${id}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      fetchVocabs(page, filters, sortConfig);
      if (selectedVocab?.id === id) setSelectedVocab(null);
    } catch (e) { alert("Failed"); }
  };

  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file || !token) return;
    const formData = new FormData();
    formData.append('file', file);
    try {
      setIsUploading(true);
      await axios.post('http://localhost:5000/vocabulary/import/csv', formData, {
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'multipart/form-data' },
      });
      alert('Import success!');
      fetchVocabs(1);
    } catch (error) { alert('Import failed!'); }
    finally { setIsUploading(false); if (fileInputRef.current) fileInputRef.current.value = ''; }
  };

  // --- RENDER ---
  return (
    <div className="min-h-screen bg-gray-50 p-6 text-black relative">

      {/* QUICK SEARCH MODAL */}
      {showSearch && (
        <div className="fixed inset-0 bg-black/60 z-50 flex items-start justify-center pt-32 backdrop-blur-sm transition-all" onClick={() => setShowSearch(false)}>
          <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b border-gray-100 flex items-center gap-3">
              <span className="text-xl">üîç</span>
              <input
                ref={searchInputRef}
                type="text"
                value={quickSearchText}
                onChange={handleQuickSearchChange}
                onKeyDown={(e) => e.key === 'Enter' && quickSearchResults.length === 0 && handleQuickCreate()}
                placeholder="Search English or Vietnamese..."
                className="flex-1 text-xl font-light outline-none bg-transparent placeholder-gray-400 text-gray-800 h-10"
              />
              <div className="text-xs text-gray-400 border border-gray-200 px-2 py-1 rounded">ESC to close</div>
            </div>
            <div className="bg-gray-50 max-h-[60vh] overflow-y-auto">
              {isSearching ? (
                <div className="p-8 text-center text-gray-400">Searching...</div>
              ) : quickSearchText && quickSearchResults.length === 0 ? (
                <div className="p-6 text-center">
                  <p className="text-gray-500 mb-4">No matching vocabulary found for "<span className="font-bold text-gray-800">{quickSearchText}</span>"</p>
                  <button
                    onClick={handleQuickCreate}
                    className="bg-indigo-600 text-white px-6 py-2.5 rounded-full hover:bg-indigo-700 shadow-md transition-all flex items-center gap-2 mx-auto font-medium"
                  >
                    <span>+</span> Create new word "{quickSearchText}"
                  </button>
                </div>
              ) : (
                <ul className="divide-y divide-gray-100">
                  {quickSearchResults.map(item => (
                    <li
                      key={item.id}
                      onClick={() => {
                        setSelectedVocab(item);
                        setShowSearch(false);
                      }}
                      className="p-4 hover:bg-indigo-50 cursor-pointer transition-colors flex justify-between items-center group"
                    >
                      <div className="flex items-center gap-3">
                        <button
                          onClick={(e) => handleToggleStar(item.id, item.isStarred, e)}
                          className="focus:outline-none"
                        >
                          <StarIcon filled={item.isStarred} className={item.isStarred ? "text-yellow-400" : "text-gray-300"} />
                        </button>
                        <div>
                          <div className="font-bold text-lg text-gray-800">{item.word}</div>
                          <div className="text-sm text-gray-500 line-clamp-1">{item.meaning || <span className="italic opacity-50">No meaning</span>}</div>
                        </div>
                      </div>
                      <div className="text-xs text-gray-400 group-hover:text-indigo-500 px-2 py-1 border border-transparent group-hover:border-indigo-200 rounded">
                        View detail ‚Üµ
                      </div>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>
        </div>
      )}

      {/* DETAIL POPUP */}
      {selectedVocab && (
        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setSelectedVocab(null)}>
          <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
            <div className="bg-indigo-600 p-6 text-white relative">
              <button onClick={() => setSelectedVocab(null)} className="absolute top-4 right-4 text-white/70 hover:text-white text-xl font-bold">‚úï</button>
              <div className="flex justify-between items-start">
                <div>
                  <div className="text-sm uppercase tracking-wider opacity-80 mb-1">{selectedVocab.partOfSpeech || 'Vocabulary'}</div>
                  <h2 className="text-4xl font-bold">{selectedVocab.word}</h2>
                  <div className="mt-2 font-mono bg-indigo-700/50 inline-block px-2 py-0.5 rounded text-sm">{selectedVocab.pronunciation || '/.../'}</div>
                </div>
                <button
                  onClick={() => handleToggleStar(selectedVocab.id, selectedVocab.isStarred)}
                  className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors"
                >
                  <StarIcon filled={selectedVocab.isStarred} className="text-yellow-400 w-8 h-8" />
                </button>
              </div>
            </div>

            <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Meaning</label>
                <div className="text-lg text-gray-800 font-medium border-l-4 border-indigo-500 pl-3">
                  {selectedVocab.meaning || 'N/A'}
                </div>
              </div>
              {selectedVocab.example && (
                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Example</label>
                  <div className="text-gray-600 italic bg-gray-50 p-3 rounded-lg">"{selectedVocab.example}"</div>
                </div>
              )}
              <div className="grid grid-cols-2 gap-4 pt-2">
                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Topic</label>
                  <div className="text-sm text-gray-700 bg-gray-100 px-2 py-1 rounded inline-block">{selectedVocab.topic || 'General'}</div>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Related Words</label>
                  <div className="text-sm text-gray-700">{selectedVocab.relatedWords || '-'}</div>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Occurrence</label>
                  <div className="text-sm text-gray-700">{selectedVocab.occurrence} times</div>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Created At</label>
                  <div className="text-sm text-gray-700">{new Date(selectedVocab.createdAt).toLocaleDateString()}</div>
                </div>
              </div>
            </div>

            <div className="bg-gray-50 p-4 border-t border-gray-100 flex justify-end gap-3">
              <button
                onClick={() => handleDelete(selectedVocab.id)}
                className="text-red-600 hover:bg-red-50 px-4 py-2 rounded text-sm font-medium transition-colors"
              >
                Delete
              </button>
              <button
                onClick={() => setSelectedVocab(null)}
                className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-5 py-2 rounded text-sm font-medium transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* MAIN CONTENT */}
      <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
          <h1 className="text-3xl font-bold text-gray-800">My Vocabulary</h1>
          <p className="text-gray-500 text-sm mt-1">
            Press <kbd className="bg-gray-200 px-1.5 py-0.5 rounded text-xs border border-gray-300">Space</kbd> <kbd className="bg-gray-200 px-1.5 py-0.5 rounded text-xs border border-gray-300">Space</kbd> to Quick Search
          </p>
        </div>

        <div className="flex gap-2 items-center">
          <button
            onClick={() => {
              const newValue = !showStarredOnly;
              setShowStarredOnly(newValue);
              fetchVocabs(1, filters, sortConfig, newValue);
            }}
            className={`px-4 py-2 rounded-lg border flex items-center gap-2 transition-colors ${showStarredOnly
              ? 'bg-yellow-50 border-yellow-400 text-yellow-700'
              : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-50'
              }`}
          >
            <StarIcon filled={showStarredOnly} className={showStarredOnly ? "text-yellow-500" : "text-gray-400"} />
            <span className="text-sm font-medium">{showStarredOnly ? 'Starred Only' : 'All Words'}</span>
          </button>

          <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".csv" className="hidden" />
          <button
            onClick={() => fileInputRef.current?.click()}
            disabled={isUploading}
            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 transition-colors text-sm font-medium"
          >
            {isUploading ? 'Importing...' : 'üìÇ Import CSV'}
          </button>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
        <div className="overflow-x-auto pb-4">
          <table className="min-w-full divide-y divide-gray-200 table-fixed">
            <thead className="bg-gray-50 select-none">
              <tr>
                <th className="w-12 px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase border-r border-gray-200">‚òÖ</th>
                <th onClick={() => handleSort('createdAt')} className="w-32 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase cursor-pointer hover:bg-gray-100 border-r border-gray-200 transition-colors">Time {getSortIcon('createdAt')}</th>
                <th onClick={() => handleSort('topic')} className="w-32 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase cursor-pointer hover:bg-gray-100 border-r border-gray-200 transition-colors">Topic {getSortIcon('topic')}</th>
                <th onClick={() => handleSort('word')} className="w-40 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase cursor-pointer hover:bg-gray-100 border-r border-gray-200 transition-colors">Word {getSortIcon('word')}</th>
                <th className="w-24 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase border-r border-gray-200">Type</th>
                <th className="w-32 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase border-r border-gray-200">Pronun.</th>
                <th className="w-48 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase border-r border-gray-200">Meaning</th>
                <th className="w-64 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase border-r border-gray-200">Example</th>
                <th className="w-48 px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase border-r border-gray-200">Related</th>
                <th onClick={() => handleSort('occurrence')} className="w-20 px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase cursor-pointer hover:bg-gray-100 border-r border-gray-200 transition-colors">Count {getSortIcon('occurrence')}</th>
                <th className="w-24 px-4 py-3 text-center text-xs font-bold text-gray-500 uppercase sticky right-0 bg-gray-50 shadow-l z-10">Actions</th>
              </tr>
              <tr className="bg-white border-b border-gray-200">
                <td className="p-2 border-r border-gray-100"></td>
                <td className="p-2 border-r border-gray-100"></td>
                <td className="p-2 border-r border-gray-100"><input className="w-full border rounded px-2 py-1 text-xs focus:border-indigo-500 outline-none" placeholder="Filter..." value={filters.topic} onChange={(e) => handleFilterChange('topic', e.target.value)} /></td>
                <td className="p-2 border-r border-gray-100"><input className="w-full border rounded px-2 py-1 text-xs focus:border-indigo-500 outline-none" placeholder="Filter..." value={filters.word} onChange={(e) => handleFilterChange('word', e.target.value)} /></td>
                <td className="p-2 border-r border-gray-100"><input className="w-full border rounded px-2 py-1 text-xs focus:border-indigo-500 outline-none" placeholder="Type..." value={filters.partOfSpeech} onChange={(e) => handleFilterChange('partOfSpeech', e.target.value)} /></td>
                <td className="p-2 border-r border-gray-100"></td>
                <td className="p-2 border-r border-gray-100"><input className="w-full border rounded px-2 py-1 text-xs focus:border-indigo-500 outline-none" placeholder="Meaning..." value={filters.meaning} onChange={(e) => handleFilterChange('meaning', e.target.value)} /></td>
                <td className="p-2 border-r border-gray-100"></td>
                <td className="p-2 border-r border-gray-100"></td>
                <td className="p-2 border-r border-gray-100"></td>
                <td className="p-2 sticky right-0 bg-white z-10"></td>
              </tr>
            </thead>

            <tbody className="bg-white divide-y divide-gray-200">
              {loading ? (
                <tr><td colSpan={11} className="text-center py-10 text-gray-500">Loading data...</td></tr>
              ) : vocabs.length === 0 ? (
                <tr><td colSpan={11} className="text-center py-10 text-gray-500">No vocabulary found.</td></tr>
              ) : (
                vocabs.map((vocab) => (
                  <tr
                    key={vocab.id}
                    className="hover:bg-indigo-50/30 group transition-colors cursor-pointer"
                    onClick={() => setSelectedVocab(vocab)}
                  >
                    <td className="px-2 py-3 text-center border-r border-gray-100 align-top" onClick={(e) => e.stopPropagation()}>
                      <button onClick={(e) => handleToggleStar(vocab.id, vocab.isStarred, e)} className="hover:bg-gray-100 rounded-full p-1">
                        <StarIcon filled={vocab.isStarred} className={vocab.isStarred ? "text-yellow-400 w-5 h-5" : "text-gray-300 w-5 h-5"} />
                      </button>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-500 whitespace-normal break-words border-r border-gray-100 align-top">{new Date(vocab.createdAt).toLocaleDateString()}</td>
                    <td className="px-4 py-3 text-sm text-gray-600 whitespace-normal break-words border-r border-gray-100 align-top">{vocab.topic && <span className="bg-gray-100 px-2 py-0.5 rounded text-xs">{vocab.topic}</span>}</td>
                    <td className="px-4 py-3 text-sm font-bold text-indigo-700 whitespace-normal break-words border-r border-gray-100 align-top">{vocab.word}</td>
                    <td className="px-4 py-3 text-sm text-gray-500 whitespace-normal break-words border-r border-gray-100 align-top italic">{vocab.partOfSpeech}</td>
                    <td className="px-4 py-3 text-sm font-mono text-gray-500 whitespace-normal break-words border-r border-gray-100 align-top">{vocab.pronunciation}</td>
                    <td className="px-4 py-3 text-sm text-gray-800 whitespace-normal break-words border-r border-gray-100 align-top">{vocab.meaning}</td>
                    <td className="px-4 py-3 text-sm text-gray-500 whitespace-normal break-words border-r border-gray-100 align-top italic">{vocab.example}</td>
                    <td className="px-4 py-3 text-sm text-gray-500 whitespace-normal break-words border-r border-gray-100 align-top">{vocab.relatedWords}</td>
                    <td className="px-4 py-3 text-sm text-center font-semibold text-gray-500 border-r border-gray-100 align-top">{vocab.occurrence}</td>
                    <td className="px-2 py-3 text-center align-top sticky right-0 bg-white group-hover:bg-indigo-50/30 shadow-l z-10 border-l border-gray-200" onClick={(e) => e.stopPropagation()}>
                      <div className="flex flex-col gap-2 items-center">
                        <button onClick={() => alert("Edit: " + vocab.word)} className="text-blue-600 hover:text-blue-800 text-xs border border-blue-200 px-2 py-1 rounded hover:bg-blue-50 w-full">Edit</button>
                        <button onClick={() => handleDelete(vocab.id)} className="text-red-600 hover:text-red-800 text-xs border border-red-200 px-2 py-1 rounded hover:bg-red-50 w-full">Del</button>
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>

        <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center sticky bottom-0 z-20">
          <button disabled={page <= 1} onClick={() => { const newPage = page - 1; setPage(newPage); fetchVocabs(newPage, filters, sortConfig); }} className="px-4 py-2 bg-white border rounded shadow-sm hover:bg-gray-100 disabled:opacity-50 text-sm font-medium">‚Üê Previous</button>
          <span className="text-sm font-medium text-gray-600">Page <span className="text-indigo-600 font-bold">{page}</span> of {totalPages}</span>
          <button disabled={page >= totalPages} onClick={() => { const newPage = page + 1; setPage(newPage); fetchVocabs(newPage, filters, sortConfig); }} className="px-4 py-2 bg-white border rounded shadow-sm hover:bg-gray-100 disabled:opacity-50 text-sm font-medium">Next ‚Üí</button>
        </div>
      </div>
    </div>
  );
}

function StarIcon({ filled, className }: { filled: boolean; className?: string }) {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill={filled ? "currentColor" : "none"}
      stroke="currentColor"
      strokeWidth={filled ? "0" : "2"}
      strokeLinecap="round"
      strokeLinejoin="round"
      className={className}
      width="24"
      height="24"
    >
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
    </svg>
  );
}


================================================
FILE: apps/frontend/app/vocabulary/tree.txt
================================================
vocabulary
‚îú‚îÄ‚îÄ page.tsx
‚îî‚îÄ‚îÄ tree.txt



================================================
FILE: apps/frontend/contexts/AuthContext.tsx
================================================
'use client';

import React, { createContext, useContext, useState, useEffect } from 'react';
import axios from 'axios';

interface User {
  id: string;
  email: string;
  name: string;
  avatar?: string;
}

interface AuthContextType {
  user: User | null;
  token: string | null;
  login: (email: string, password: string) => Promise<void>;
  register: (email: string, password: string, name?: string) => Promise<void>;
  logout: () => void;
  isLoading: boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [token, setToken] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  // Load token from localStorage on mount
  useEffect(() => {
    const savedToken = localStorage.getItem('token');
    if (savedToken) {
      setToken(savedToken);
      fetchUser(savedToken);
    } else {
      setIsLoading(false);
    }
  }, []);

  // Fetch user info
  const fetchUser = async (authToken: string) => {
    try {
      const response = await axios.get('http://localhost:5000/auth/me', {
        headers: { Authorization: `Bearer ${authToken}` },
      });
      setUser(response.data);
    } catch (error) {
      console.error('Failed to fetch user:', error);
      localStorage.removeItem('token');
      setToken(null);
    } finally {
      setIsLoading(false);
    }
  };

  // Login
  const login = async (email: string, password: string) => {
    const response = await axios.post('http://localhost:5000/auth/login', {
      email,
      password,
    });

    const { token: newToken, user: newUser } = response.data;
    
    localStorage.setItem('token', newToken);
    setToken(newToken);
    setUser(newUser);
  };

  // Register
  const register = async (email: string, password: string, name?: string) => {
    const response = await axios.post('http://localhost:5000/auth/register', {
      email,
      password,
      name,
    });

    const { token: newToken, user: newUser } = response.data;
    
    localStorage.setItem('token', newToken);
    setToken(newToken);
    setUser(newUser);
  };

  // Logout
  const logout = () => {
    localStorage.removeItem('token');
    setToken(null);
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, token, login, register, logout, isLoading }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

